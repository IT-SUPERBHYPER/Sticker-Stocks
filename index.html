<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Superb Sticker Inventory </title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè∑Ô∏è</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* ===== ULTRA HIGH-RES & EYE-POPPING THEME ===== */
    :root {
      /* Light Theme Vibrant Colors */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      /* Ultra-Vibrant Accent Colors */
      --accent-primary: #4338ca; /* Vibrant Indigo */
      --accent-primary-hover: #3730a3;
      --accent-secondary: #059669; /* Vibrant Emerald */
      --accent-tertiary: #d97706; /* Vibrant Amber */
      --accent-danger: #dc2626; /* Vibrant Red */
      --accent-info: #0ea5e9; /* Vibrant Sky Blue */
      /* Status Colors */
      --status-out: #fecaca; /* Red-200 */
      --status-out-text: #7f1d1d; /* Red-900 */
      --status-low: #fde68a; /* Amber-200 */
      --status-low-text: #78350f; /* Amber-900 */
      /* Radii & Transitions */
      --radius-xs: 4px;
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 24px;
      --transition-all: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --transition-fast: all 0.2s ease-in-out;
    }
    /* Dark Theme Overrides */
    html.dark {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --status-out: #7f1d1d; /* Red-900 */
      --status-out-text: #fecaca; /* Red-200 */
      --status-low: #78350f; /* Amber-900 */
      --status-low-text: #fde68a; /* Amber-200 */
    }
    /* ===== BASE STYLES & HIGH-RES ===== */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    html {
        font-size: 17px;
        scroll-behavior: smooth;
    }
    @media (min-resolution: 2dppx) {
        html { font-size: 18px; }
    }
    body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        min-height: 100vh;
        padding: 15px;
        background-image:
            radial-gradient(circle at 10% 20%, rgba(67, 56, 202, 0.08) 0%, transparent 25%),
            radial-gradient(circle at 90% 80%, rgba(5, 150, 105, 0.08) 0%, transparent 25%);
        background-attachment: fixed;
        transition: var(--transition-all);
    }
    html.dark body {
        background-image:
            radial-gradient(circle at 10% 20%, rgba(67, 56, 202, 0.15) 0%, transparent 25%),
            radial-gradient(circle at 90% 80%, rgba(5, 150, 105, 0.15) 0%, transparent 25%);
    }
    .container {
      max-width: 1100px;
      margin: 25px auto;
      background-color: var(--bg-card);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-2xl);
      padding: 35px;
      transition: var(--transition-all);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    .container::before {
        content: "";
        position: absolute;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: conic-gradient(
            from 0deg at 50% 50%,
            var(--accent-primary) 0deg,
            var(--accent-secondary) 120deg,
            var(--accent-tertiary) 240deg,
            var(--accent-primary) 360deg
        );
        opacity: 0;
        z-index: -2;
        animation: rotateHue 10s linear infinite;
        transition: opacity 0.8s ease;
    }
    .container:hover::before {
        opacity: 0.08;
    }
    .container::after {
        content: "";
        position: absolute;
        inset: 1px;
        background: var(--bg-card);
        border-radius: var(--radius-2xl);
        z-index: -1;
    }
    @keyframes rotateHue {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    /* Animations */
    @keyframes fadeInScale {
        from { opacity: 0; transform: translateY(30px) scale(0.97); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes slideInFromLeft {
        from { opacity: 0; transform: translateX(-40px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInFromRight {
        from { opacity: 0; transform: translateX(40px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
    }
    @keyframes pulseGlow {
        0% { box-shadow: 0 0 0 0 rgba(67, 56, 202, 0.5); }
        70% { box-shadow: 0 0 0 15px rgba(67, 56, 202, 0); }
        100% { box-shadow: 0 0 0 0 rgba(67, 56, 202, 0); }
    }
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    /* Headings */
    h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.8rem;
      font-weight: 900;
      text-align: center;
      margin-bottom: 25px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-tertiary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      animation: fadeInScale 0.9s ease-out;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    h1::after {
        content: "";
        display: block;
        width: 100px;
        height: 5px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        margin: 15px auto 0;
        border-radius: 3px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.7rem;
      font-weight: 800;
      color: var(--accent-primary);
      margin: 35px 0 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInFromLeft 0.7s ease-out;
      letter-spacing: -0.3px;
    }
    h2 i {
        font-size: 1.3em;
        flex-shrink: 0;
    }
    /* Layout & Controls */
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
      margin-bottom: 25px;
      animation: slideInFromRight 0.7s ease-out;
    }
    #darkToggleBtn {
      position: absolute;
      right: 20px;
      top: 20px;
      z-index: 100;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 50%;
      font-size: 1.5em;
      width: 55px; height: 55px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: var(--transition-all);
    }
    #darkToggleBtn:hover {
        transform: rotate(20deg) scale(1.15);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        box-shadow: var(--shadow-lg);
        background: var(--bg-secondary);
    }
    html.dark #darkToggleBtn {
        background: var(--bg-secondary);
    }
    /* Buttons - Eye-Popping */
    .action-btn, button, .reset-btn, .download-btn, .upload-btn, .audit-btn, .export-btn, .stats-full-btn {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      border-radius: var(--radius-md);
      border: none;
      padding: 12px 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition-all);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      font-size: 1.05rem;
      letter-spacing: 0.2px;
    }
    .action-btn::before, button::before, .export-btn::before, .stats-full-btn::before {
        content: "";
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: 0.6s;
    }
    .action-btn:hover::before, button:hover::before, .export-btn:hover::before, .stats-full-btn:hover::before {
        left: 100%;
    }
    .action-btn:active, button:active, .export-btn:active, .stats-full-btn:active {
        transform: scale(0.96);
        transition: var(--transition-fast);
    }
    .action-btn:focus-visible, button:focus-visible, .export-btn:focus-visible, .stats-full-btn:focus-visible {
        outline: 2px dashed var(--accent-info);
        outline-offset: 2px;
    }
    .action-btn:disabled, button:disabled, .export-btn:disabled, .stats-full-btn:disabled {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
        box-shadow: var(--shadow-xs);
    }
    /* Specific Button Styles */
    button, .action-btn:not(.eye-btn, .edit-btn, .del-btn) {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        border: 1px solid var(--accent-primary-hover);
    }
    button:hover, .action-btn:not(.eye-btn, .edit-btn, .del-btn):hover {
        background: linear-gradient(135deg, var(--accent-primary-hover), var(--accent-primary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .export-btn {
        background: linear-gradient(135deg, var(--accent-secondary), #047857);
        color: white;
        border: 1px solid #047857;
    }
    .export-btn:hover {
        background: linear-gradient(135deg, #047857, var(--accent-secondary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .action-btn.eye-btn {
        background-color: var(--bg-primary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }
    .action-btn.eye-btn:hover {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        border-color: var(--accent-primary);
        box-shadow: var(--shadow-md);
        transform: translateY(-3px);
    }
    .action-btn.edit-btn {
        background: linear-gradient(135deg, var(--accent-tertiary), #b45309);
        color: white;
        border: 1px solid #b45309;
    }
    .action-btn.edit-btn:hover {
        background: linear-gradient(135deg, #b45309, var(--accent-tertiary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .action-btn.del-btn, .reset-btn {
        background: linear-gradient(135deg, var(--accent-danger), #991b1b);
        color: white;
        border: 1px solid #991b1b;
    }
    .action-btn.del-btn:hover, .reset-btn:hover {
        background: linear-gradient(135deg, #991b1b, var(--accent-danger));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .download-btn {
        background: linear-gradient(135deg, var(--accent-info), #0284c7);
        color: white;
        border: 1px solid #0284c7;
    }
    .download-btn:hover {
        background: linear-gradient(135deg, #0284c7, var(--accent-info));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .upload-btn {
        background: linear-gradient(135deg, var(--accent-tertiary), #b45309);
        color: white;
        border: 1px solid #b45309;
    }
    .upload-btn:hover {
        background: linear-gradient(135deg, #b45309, var(--accent-tertiary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .audit-btn {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        border: 1px solid var(--accent-primary-hover);
    }
    .audit-btn:hover {
        background: linear-gradient(135deg, var(--accent-primary-hover), var(--accent-primary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .stats-full-btn {
        background: linear-gradient(135deg, #9333ea, #7c3aed);
        color: white;
        border: 1px solid #7c3aed;
    }
    .stats-full-btn:hover {
        background: linear-gradient(135deg, #7c3aed, #9333ea);
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    /* Forms - High-Res & Friendly */
    .form-pair-group {
        display: flex;
        gap: 25px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        animation: fadeInScale 0.8s ease-out;
    }
    .form-group {
        flex: 1;
        min-width: 220px;
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
    }
    .form-group label {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 8px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 7px;
    }
    .form-group input, .form-group select {
        padding: 14px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 1.05rem;
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        transition: var(--transition-all);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        min-height: 50px;
    }
    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 4px rgba(67, 56, 202, 0.25);
        background-color: var(--bg-card);
    }
    html.dark .form-group input, html.dark .form-group select {
        background-color: var(--bg-primary);
    }
    /* Table - High-Res & Friendly */
    .table-responsive {
        overflow-x: auto;
        margin-top: 25px;
        animation: fadeInScale 0.9s ease-out;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: var(--bg-card);
        min-width: 800px;
    }
    th {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        font-weight: 700;
        text-align: center;
        padding: 18px 14px;
        font-size: 1.05rem;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        position: relative;
        overflow: hidden;
    }
    th::after {
        content: "";
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
        animation: shimmer 2s infinite;
    }
    td {
        padding: 16px 14px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        transition: var(--transition-all);
        font-size: 1rem;
    }
    tr:last-child td {
        border-bottom: none;
    }
    tr:nth-child(even) td {
        background-color: rgba(67, 56, 202, 0.02);
    }
    html.dark tr:nth-child(even) td {
        background-color: rgba(255, 255, 255, 0.03);
    }
    tr:hover td {
        background-color: rgba(67, 56, 202, 0.06);
        transform: scale(1.015);
        z-index: 1;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    html.dark tr:hover td {
        background-color: rgba(67, 56, 202, 0.12);
    }
    .out-stock td {
        background-color: var(--status-out) !important;
        color: var(--status-out-text);
        font-weight: 600;
    }
    .low-stock td {
        background-color: var(--status-low) !important;
        color: var(--status-low-text);
        font-weight: 600;
    }
    .total-col {
        font-weight: 700;
        color: var(--accent-primary);
    }
    /* Modals - High-Res & Friendly with Scrollable Content */
    #addStockModal, #usageModal, #statsModal, #exportModal, #transactionHistoryModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.4s ease-out;
      backdrop-filter: blur(8px);
    }
    .modal-content {
      background-color: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2xl);
      width: 92%;
      max-width: 900px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      position: relative;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid var(--border-color);
    }
    #statsModal .modal-content {
      max-width: 1000px;
      max-height: 85vh;
    }
    .modal-content > div:not(.modal-header) {
        overflow-y: auto;
        flex-grow: 1;
        padding: 0 20px 20px 20px;
    }
    .modal-content h3 {
        margin: 0;
        padding: 25px 20px 15px 20px;
        flex-shrink: 0;
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--accent-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    @keyframes popIn {
        0% { opacity: 0; transform: scale(0.7); }
        100% { opacity: 1; transform: scale(1); }
    }
    .modal-close {
        position: absolute;
        top: 18px;
        right: 18px;
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: var(--text-secondary);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-all);
        z-index: 10;
    }
    .modal-close:hover {
        background-color: var(--border-color);
        color: var(--accent-danger);
        transform: rotate(90deg) scale(1.1);
        box-shadow: var(--shadow-sm);
    }
    #usageListTable, #transactionTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        display: block;
        max-width: 100%;
        overflow-x: auto;
    }
    #usageListTable thead, #usageListTable tbody,
    #transactionTable thead, #transactionTable tbody {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    #usageListTable th, #usageListTable td,
    #transactionTable th, #transactionTable td {
        padding: 14px 10px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
        word-wrap: break-word;
    }
    #usageListTable th, #transactionTable th {
        background-color: var(--bg-primary);
        color: var(--accent-primary);
        font-weight: 700;
        position: sticky;
        top: 0;
    }
    #usageListTable tr:last-child td,
    #transactionTable tr:last-child td {
        border-bottom: none;
    }
    #usageListTable tr:nth-child(even),
    #transactionTable tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.02);
    }
    html.dark #usageListTable tr:nth-child(even),
    html.dark #transactionTable tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.04);
    }
    /* Stats & Export Tabs */
    #statsTabs, #exportTypeTabs, #fullStatsTabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 25px 20px 25px 20px;
        flex-shrink: 0;
    }
    #statsTabs button, #exportTypeTabs button, #fullStatsTabs button {
        background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 10px 17px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-all);
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }
    #statsTabs button.active, #exportTypeTabs button.active, #fullStatsTabs button.active,
    #statsTabs button:hover, #exportTypeTabs button:hover, #fullStatsTabs button:hover {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        border-color: var(--accent-primary);
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }
    #statsTable {
        width: 100%;
        border-collapse: collapse;
        display: block;
        max-width: 100%;
        overflow-x: auto;
        margin-bottom: 20px;
    }
    #statsTable thead, #statsTable tbody {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    #statsTable th, #statsTable td {
        padding: 14px 12px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
        word-wrap: break-word;
    }
    #statsTable th {
        background-color: var(--bg-primary);
        color: var(--accent-primary);
        font-weight: 700;
        position: sticky;
        top: 0;
    }
    /* Enhanced Stats Styles */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      padding: 20px;
    }
    
    .stats-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md);
      padding: 25px;
      transition: var(--transition-all);
    }
    
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .stats-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--accent-primary);
    }
    
    .stats-header i {
      font-size: 1.5em;
      color: var(--accent-primary);
      background: rgba(67, 56, 202, 0.1);
      padding: 12px;
      border-radius: 50%;
    }
    
    .stats-header h4 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent-primary);
    }
    
    .stats-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px 15px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--accent-secondary);
    }
    
    html.dark .stats-metric {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .stats-metric.danger {
      border-left-color: var(--accent-danger);
    }
    
    .stats-metric.warning {
      border-left-color: var(--accent-tertiary);
    }
    
    .metric-label {
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .metric-value {
      font-weight: 800;
      font-size: 1.4rem;
      color: var(--accent-primary);
    }
    
    .metric-value.danger {
      color: var(--accent-danger);
    }
    
    .metric-value.warning {
      color: var(--accent-tertiary);
    }
    
    .metric-value.success {
      color: var(--accent-secondary);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-item {
      background: rgba(67, 56, 202, 0.05);
      border-radius: var(--radius-md);
      padding: 15px;
      text-align: center;
      transition: var(--transition-all);
      border: 1px solid transparent;
    }
    
    html.dark .stat-item {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .stat-item:hover {
      transform: translateY(-3px);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-md);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .stat-number {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--accent-primary);
      margin-bottom: 5px;
    }
    
    .stat-unit {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .chart-container {
      height: 200px;
      margin: 20px 0;
      position: relative;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 100%;
      padding: 20px;
    }
    
    .bar {
      flex: 1;
      margin: 0 5px;
      background: linear-gradient(to top, var(--accent-primary), var(--accent-primary-hover));
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: all 0.3s ease;
      min-width: 30px;
    }
    
    .bar:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(67, 56, 202, 0.3);
    }
    
    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 600;
      transform: rotate(-45deg);
      transform-origin: left top;
      white-space: nowrap;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .data-table th {
      background: var(--accent-primary);
      color: white;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
    }
    
    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .data-table tr:nth-child(even) {
      background: rgba(0, 0, 0, 0.02);
    }
    
    html.dark .data-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .data-table tr:hover {
      background: rgba(67, 56, 202, 0.05);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .period-indicator {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(67, 56, 202, 0.1);
      color: var(--accent-primary);
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.9rem;
      margin-left: 10px;
    }
    
    /* Full Page Stats Dashboard */
    #fullPageStats {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--bg-primary);
      z-index: 10000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .stats-dashboard {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .dashboard-header h1 {
      margin: 0;
      text-align: left;
      font-size: 2.5rem;
      background: linear-gradient(90deg, var(--accent-primary), #9333ea);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .dashboard-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    #fullStatsContent {
      min-height: calc(100vh - 180px);
    }
    
    .full-stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }
    
    .full-stats-card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-lg);
      padding: 30px;
      transition: var(--transition-all);
    }
    
    .full-stats-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-xl);
    }
    
    .full-stats-card.wide {
      grid-column: span 2;
    }
    
    .full-chart-container {
      height: 300px;
      margin: 25px 0;
      position: relative;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      padding: 20px;
    }
    
    .full-bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 100%;
    }
    
    .full-bar {
      flex: 1;
      margin: 0 8px;
      background: linear-gradient(to top, var(--accent-primary), var(--accent-primary-hover));
      border-radius: 6px 6px 0 0;
      position: relative;
      transition: all 0.3s ease;
      min-width: 40px;
    }
    
    .full-bar-label {
      position: absolute;
      bottom: -30px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 600;
      transform: rotate(-45deg);
      transform-origin: left top;
      white-space: nowrap;
    }
    
    .full-data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .full-data-table th {
      background: var(--accent-primary);
      color: white;
      padding: 15px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .full-data-table td {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.95rem;
    }
    
    .full-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }
    
    .full-stat-item {
      background: linear-gradient(135deg, rgba(67, 56, 202, 0.1), rgba(5, 150, 105, 0.1));
      border-radius: var(--radius-lg);
      padding: 20px;
      text-align: center;
      transition: var(--transition-all);
      border: 1px solid transparent;
    }
    
    html.dark .full-stat-item {
      background: linear-gradient(135deg, rgba(67, 56, 202, 0.2), rgba(5, 150, 105, 0.2));
    }
    
    .full-stat-item:hover {
      transform: translateY(-5px);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-lg);
    }
    
    .full-stat-label {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .full-stat-number {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--accent-primary);
      margin-bottom: 5px;
      line-height: 1;
    }
    
    .full-stat-unit {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }
    
    .comparison-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 25px;
      border: 1px solid var(--border-color);
    }
    
    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .trend-up {
      background: rgba(5, 150, 105, 0.1);
      color: var(--accent-secondary);
    }
    
    .trend-down {
      background: rgba(220, 38, 38, 0.1);
      color: var(--accent-danger);
    }
    
    .trend-neutral {
      background: rgba(100, 116, 139, 0.1);
      color: var(--text-secondary);
    }
    
    /* Loader */
    #loader {
        display: none;
        position: fixed;
        z-index: 99999;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(255, 255, 255, 0.85);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
    }
    html.dark #loader {
        background-color: rgba(15, 23, 42, 0.9);
    }
    .loader-spinner {
        width: 60px;
        height: 60px;
        border: 6px solid var(--border-color);
        border-top: 6px solid var(--accent-primary);
        border-radius: 50%;
        animation: spin 1.2s linear infinite, pulseGlow 1.8s infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Login Modal */
    #loginModal {
        position: fixed;
        z-index: 999999;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #0f172a, #1e293b);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(15px);
    }
    #loginForm {
        background: var(--bg-card);
        padding: 45px;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-2xl);
        text-align: center;
        width: 90%;
        max-width: 450px;
        animation: float 4s ease-in-out infinite;
        border: 1px solid var(--border-color);
    }
    #loginForm h2 {
        justify-content: center;
        margin-top: 0;
        font-size: 2.2rem;
        margin-bottom: 25px;
        color: var(--accent-primary);
    }
    #loginForm input {
        width: 100%;
        padding: 16px;
        margin: 25px 0;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        font-size: 1.1rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: var(--transition-all);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    #loginForm input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 4px rgba(67, 56, 202, 0.25);
    }
    #loginForm button {
        width: 100%;
        padding: 14px;
        font-size: 1.2rem;
        margin-top: 10px;
    }
    #loginError {
        color: var(--accent-danger);
        margin-top: 20px;
        display: none;
        animation: shake 0.6s;
        font-weight: 500;
        padding: 12px;
        border-radius: var(--radius-sm);
        background-color: rgba(220, 38, 38, 0.1);
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-7px); }
        75% { transform: translateX(7px); }
    }
    /* Utility Classes */
    .text-center { text-align: center; }
    .mt-10 { margin-top: 10px; }
    .mb-10 { margin-bottom: 10px; }
    .ml-5 { margin-left: 5px; }
    /* Responsive - Mobile Friendly */
    @media (max-width: 1100px) {
        .container { max-width: 95%; }
        .full-stats-container,
        .full-stats-card.wide {
            grid-template-columns: 1fr;
            grid-column: 1;
        }
    }
    @media (max-width: 768px) {
        html { font-size: 16px; }
        .container {
            padding: 25px 20px;
            margin: 15px auto;
            border-radius: var(--radius-xl);
        }
        .form-pair-group {
            flex-direction: column;
            gap: 0;
        }
        .form-group {
            min-width: 100%;
            margin-bottom: 18px;
        }
        h1 {
            font-size: 2.2rem;
            margin-bottom: 20px;
        }
        h1::after {
            width: 80px;
            height: 4px;
        }
        h2 {
            font-size: 1.5rem;
            margin: 30px 0 18px;
            gap: 10px;
        }
        .flex-row {
            gap: 8px;
            justify-content: center;
        }
        .action-btn, button, .reset-btn, .download-btn, .upload-btn, .audit-btn, .export-btn, .stats-full-btn {
            padding: 10px 14px;
            font-size: 0.95rem;
            gap: 6px;
        }
        th, td {
            padding: 12px 8px;
            font-size: 0.9rem;
        }
        #darkToggleBtn {
            right: 12px;
            top: 12px;
            width: 48px;
            height: 48px;
            font-size: 1.3em;
        }
        .modal-content {
            padding: 0;
            width: 95%;
            max-width: none;
            max-height: 95vh;
        }
        #statsModal .modal-content {
            max-height: 90vh;
        }
        .modal-content h3 {
            font-size: 1.6rem;
            padding: 20px 15px 10px 15px;
        }
        .modal-close {
             top: 15px;
             right: 15px;
             width: 40px;
             height: 40px;
             font-size: 1.8rem;
        }
        #usageListTable th, #usageListTable td,
        #statsTable th, #statsTable td,
        #transactionTable th, #transactionTable td {
            padding: 10px 6px;
            font-size: 0.85rem;
        }
        #statsTabs, #exportTypeTabs, #fullStatsTabs {
             margin: 20px 15px;
        }
        #statsTabs button, #exportTypeTabs button, #fullStatsTabs button {
             padding: 8px 12px;
             font-size: 0.9rem;
        }
        .stats-container {
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 15px;
        }
        .stats-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
        .stats-card {
            padding: 20px;
        }
        .stat-number {
            font-size: 1.5rem;
        }
        .bar-label {
            font-size: 0.7rem;
            transform: rotate(-45deg) scale(0.8);
        }
        #loginForm {
            padding: 35px 25px;
            width: 95%;
        }
        #loginForm h2 {
            font-size: 1.9rem;
        }
        #loginForm input {
            padding: 14px;
            font-size: 1rem;
        }
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        .dashboard-header h1 {
            font-size: 2rem;
        }
        .dashboard-controls {
            width: 100%;
            justify-content: space-between;
        }
        .full-stats-container {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .full-stats-card {
            padding: 20px;
        }
        .full-chart-container {
            height: 200px;
        }
        .full-stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .full-stat-number {
            font-size: 1.8rem;
        }
    }
    @media (max-width: 480px) {
        html { font-size: 15px; }
        h1 { font-size: 1.9rem; }
        h2 { font-size: 1.3rem; }
        .container { padding: 20px 15px; }
        .form-group input, .form-group select {
            padding: 12px 14px;
            font-size: 1rem;
        }
        th, td {
            padding: 10px 5px;
            font-size: 0.82rem;
        }
        .action-btn, button, .reset-btn, .download-btn, .upload-btn, .audit-btn, .export-btn, .stats-full-btn {
            padding: 9px 12px;
            font-size: 0.9rem;
        }
        #darkToggleBtn {
            width: 42px;
            height: 42px;
        }
        .modal-content h3 {
             font-size: 1.4rem;
             padding: 18px 12px 8px 12px;
        }
        .modal-close {
             top: 12px;
             right: 12px;
             width: 38px;
             height: 38px;
             font-size: 1.7rem;
        }
        #usageListTable th, #usageListTable td,
        #statsTable th, #statsTable td,
        #transactionTable th, #transactionTable td {
             padding: 8px 4px;
             font-size: 0.8rem;
        }
        #statsTabs, #exportTypeTabs, #fullStatsTabs {
             margin: 15px 10px;
             gap: 6px;
        }
        #statsTabs button, #exportTypeTabs button, #fullStatsTabs button {
             padding: 7px 10px;
             font-size: 0.85rem;
        }
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .full-stats-grid {
            grid-template-columns: 1fr;
        }
        .full-stat-number {
            font-size: 1.5rem;
        }
    }
  </style>
</head>
<body>
<!-- Login Modal -->
<div id="loginModal">
  <form id="loginForm">
    <h2><i class="fas fa-lock"></i> Secure Login</h2>
    <input type="password" id="loginPassword" placeholder="Enter password..." autocomplete="current-password" autofocus>
    <button type="submit"><i class="fas fa-sign-in-alt"></i> Access Inventory</button>
    <div id="loginError"><i class="fas fa-exclamation-triangle"></i> Incorrect password. Please try again.</div>
  </form>
</div>
<!-- Dark Mode Toggle -->
<button id="darkToggleBtn" title="Toggle Theme" aria-label="Toggle Dark/Light Mode">
    <i class="fas fa-moon"></i>
</button>
<!-- Main Container -->
<div class="container">
  <h1><i class="fas fa-tags"></i> Superb Sticker Inventory </h1>
  <!-- Loader -->
  <div id="loader">
    <div class="loader-spinner"></div>
  </div>
  <!-- Action Buttons - SIMPLIFIED -->
  <div class="flex-row">
    <button class="export-btn" onclick="showExportModal()" title="Export Reports"><i class="fas fa-file-export"></i> Export</button>
    <button class="download-btn" onclick="downloadJSON()" title="Backup Data Locally"><i class="fas fa-download"></i> Backup</button>
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Restore Data from Backup"><i class="fas fa-upload"></i> Restore</button>
    <button class="audit-btn admin-only" onclick="showTransactionHistoryModal()" title="View Full Transaction Log"><i class="fas fa-clipboard-list"></i> Audit Log</button>
    <button onclick="showStatsModal()" title="View Usage Statistics"><i class="fas fa-chart-pie"></i> Stats</button>
    <button class="stats-full-btn" onclick="showFullPageStats()" title="Full Page Statistics Dashboard"><i class="fas fa-expand-alt"></i> Full Stats</button>
    <button class="reset-btn" onclick="resetAllData()" title="‚ö†Ô∏è Delete All Data Permanently"><i class="fas fa-trash-alt"></i> Reset</button>
    <input type="file" id="fileInput" accept=".json,.csv" style="display:none" onchange="uploadJSON(event)">
  </div>
  <!-- Add Sticker Form -->
  <h2><i class="fas fa-plus-circle"></i> Add New Sticker</h2>
  <form id="addStickerForm" onsubmit="event.preventDefault();">
    <div class="form-pair-group">
      <div class="form-group">
        <label for="stickerName"><i class="fas fa-font"></i> Sticker Name</label>
        <input type="text" id="stickerName" autocomplete="off" placeholder="e.g., Premium Barcode Sticker">
      </div>
      <div class="form-group">
        <label for="stickerLabel"><i class="fas fa-tag"></i> Sticker Label</label>
        <select id="stickerLabel">
          <option value="">-- Select Label --</option>
          <option value="SCALE LABELS (BW500)">SCALE LABELS (BW500)</option>
          <option value="CHICKEN LABELS">CHICKEN LABELS</option>
          <option value="BEEF LABELS">BEEF LABELS</option>
          <option value="MUTTON LABELS">MUTTON LABELS</option>
          <option value="MINCE LABELS">MINCE LABELS</option>
          <option value="SPECIAL OFFER (GREEN)">SPECIAL OFFER (GREEN)</option>
          <option value="SPECIAL OFFER (ORANGE)">SPECIAL OFFER (ORANGE)</option>
          <option value="BARCODE LABELS">BARCODE LABELS</option>
          <option value="ARROW LABELS">ARROW LABELS</option>
          <option value="SECURITY TAPE (RED)">SECURITY TAPE (RED)</option>
          <option value="SECURITY TAPE (BLUE)">SECURITY TAPE (BLUE)</option>
          <option value="SECURITY STICKERS (GREEN)">SECURITY STICKERS (GREEN)</option>
          <option value="SECURITY STICKERS (BLUE)">SECURITY STICKERS (BLUE)</option>
          <option value="SECURITY STICKERS (RED)">SECURITY STICKERS (RED)</option>
          <option value="COLOUR PAPER">COLOUR PAPER</option>
          <option value="INVOICE/REFERENCE STICKER">INVOICE/REFERENCE STICKER</option>
        </select>
      </div>
      <div class="form-group">
        <label for="initialStock"><i class="fas fa-boxes"></i> Initial Stock</label>
        <input type="number" id="initialStock" min="0" placeholder="e.g., 1000">
      </div>
      <div class="form-group">
        <label for="stickerCost"><i class="fas fa-coins"></i> Cost per Sticker (R)</label>
        <input type="number" id="stickerCost" step="0.01" min="0" placeholder="e.g., 0.75">
      </div>
    </div>
    <button type="button" id="addStickerBtn" onclick="addSticker()" disabled><i class="fas fa-plus"></i> Add Sticker</button>
  </form>
  <!-- Deduct Sticker Form -->
  <h2><i class="fas fa-minus-circle"></i> Deduct Sticker Usage</h2>
  <form onsubmit="event.preventDefault();">
    <div class="form-pair-group">
      <div class="form-group">
        <label for="selectSticker"><i class="fas fa-search"></i> Select Sticker</label>
        <select id="selectSticker">
          <option value="">-- Select Sticker --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="department"><i class="fas fa-building"></i> Department</label>
        <select id="department">
          <option value="">-- Select Department --</option>
          <option value="butchery">Butchery</option>
          <option value="spice">Spice</option>
          <option value="fruit and veg">Fruit and Veg</option>
          <option value="barcoding">Barcoding</option>
          <option value="online">Online</option>
          <option value="freezer">Freezer</option>
          <option value="retail">Retail</option>
        </select>
      </div>
      <div class="form-group">
        <label for="person"><i class="fas fa-user"></i> Person</label>
        <input type="text" id="person" placeholder="e.g., John Smith">
      </div>
      <div class="form-group">
        <label for="deductDate"><i class="fas fa-calendar-day"></i> Date of Use</label>
        <input type="date" id="deductDate">
      </div>
      <div class="form-group">
        <label for="deductAmount"><i class="fas fa-hashtag"></i> Deduct Amount</label>
        <input type="number" id="deductAmount" min="1" placeholder="e.g., 50">
      </div>
    </div>
    <button type="button" id="deductBtn" disabled><i class="fas fa-minus"></i> Deduct Stock</button>
  </form>
  <!-- Inventory Report Table -->
  <div class="table-responsive">
    <table id="reportTable">
      <thead>
        <tr>
          <th><i class="fas fa-tag"></i> Sticker Label</th>
          <th><i class="fas fa-arrow-up"></i> Used</th>
          <th><i class="fas fa-arrow-down"></i> Remaining</th>
          <th><i class="fas fa-box"></i> Total</th>
          <th class="admin-price"><i class="fas fa-money-bill-wave"></i> Cost Each</th>
          <th class="admin-price"><i class="fas fa-receipt"></i> Total Cost</th>
          <th><i class="fas fa-clock"></i> Last Use</th>
          <th><i class="fas fa-user"></i> Who</th>
          <th class="admin-only"><i class="fas fa-cogs"></i> Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data populated by JavaScript -->
      </tbody>
    </table>
  </div>
</div> <!-- End .container -->

<!-- Modals -->
<div id="addStockModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideAddStockModal()" aria-label="Close Add Stock Modal">&times;</button>
    <h3><i class="fas fa-plus-square"></i> Add Stock</h3>
    <div>
        <p id="addStockStickerName" style="font-weight:600; margin: 15px 0; font-size: 1.2rem;"></p>
        <div class="form-group">
            <label for="addStockAmount"><i class="fas fa-sort-numeric-up"></i> Amount to Add</label>
            <input type="number" id="addStockAmount" placeholder="Enter amount" min="1">
        </div>
        <div class="form-group">
            <label for="addStockPerson"><i class="fas fa-user"></i> Added By</label>
            <input type="text" id="addStockPerson" placeholder="e.g., Admin Name" required>
        </div>
        <div class="form-group">
            <label for="addStockInvoice"><i class="fas fa-file-invoice"></i> Invoice Number</label>
            <input type="text" id="addStockInvoice" placeholder="e.g., INV-2025-001" required>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
          <button onclick="addStockToSticker()" style="flex:1;"><i class="fas fa-plus"></i> Add Stock</button>
          <button onclick="hideAddStockModal()" class="action-btn del-btn" style="flex:1;"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </div>
  </div>
</div>

<div id="usageModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideUsageModal()" aria-label="Close Usage Log Modal">&times;</button>
    <h3><i class="fas fa-history"></i> Sticker Usage Log</h3>
    <div id="usageListContent" style="margin-top: 20px;">
        <!-- Usage log populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Enhanced Stats Modal -->
<div id="statsModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideStatsModal()" aria-label="Close Statistics Modal">&times;</button>
    <h3><i class="fas fa-chart-line"></i> Usage Statistics <span id="periodIndicator" class="period-indicator">Today</span></h3>
    <div id="statsTabs">
      <button id="tab-daily" onclick="showStatsTab('daily')" class="active"><i class="fas fa-calendar-day"></i> Today</button>
      <button id="tab-weekly" onclick="showStatsTab('weekly')"><i class="fas fa-calendar-week"></i> This Week</button>
      <button id="tab-monthly" onclick="showStatsTab('monthly')"><i class="fas fa-calendar-alt"></i> This Month</button>
      <button id="tab-last-week" onclick="showStatsTab('last-week')"><i class="fas fa-step-backward"></i> Last Week</button>
      <button id="tab-last-month" onclick="showStatsTab('last-month')"><i class="fas fa-step-backward"></i> Last Month</button>
    </div>
    <div id="statsContent">
        <!-- Stats content populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Full Page Statistics Dashboard -->
<div id="fullPageStats">
  <div class="stats-dashboard">
    <div class="dashboard-header">
      <h1><i class="fas fa-chart-network"></i> Full Statistics Dashboard</h1>
      <div class="dashboard-controls">
        <button onclick="exportFullStats()" class="export-btn">
          <i class="fas fa-file-export"></i> Export All
        </button>
        <button onclick="refreshFullStats()" class="action-btn">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button onclick="hideFullPageStats()" class="action-btn del-btn">
          <i class="fas fa-times"></i> Close Dashboard
        </button>
      </div>
    </div>
    
    <div id="fullStatsTabs">
      <button id="full-tab-daily" onclick="showFullStatsTab('daily')" class="active"><i class="fas fa-calendar-day"></i> Today</button>
      <button id="full-tab-weekly" onclick="showFullStatsTab('weekly')"><i class="fas fa-calendar-week"></i> This Week</button>
      <button id="full-tab-monthly" onclick="showFullStatsTab('monthly')"><i class="fas fa-calendar-alt"></i> This Month</button>
      <button id="full-tab-last-week" onclick="showFullStatsTab('last-week')"><i class="fas fa-step-backward"></i> Last Week</button>
      <button id="full-tab-last-month" onclick="showFullStatsTab('last-month')"><i class="fas fa-step-backward"></i> Last Month</button>
      <button id="full-tab-all" onclick="showFullStatsTab('all')"><i class="fas fa-chart-bar"></i> All Time</button>
    </div>
    
    <div id="fullStatsContent">
      <!-- Full page stats will render here -->
    </div>
  </div>
</div>

<!-- Consolidated Export Modal -->
<div id="exportModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideExportModal()" aria-label="Close Export Modal">&times;</button>
    <h3><i class="fas fa-file-export"></i> Export Reports</h3>
    
    <!-- Export Type Selection -->
    <div id="exportTypeTabs" style="margin: 25px 20px 15px 20px;">
      <button id="export-type-current" onclick="showExportType('current')" class="active"><i class="fas fa-boxes"></i> Current Stock</button>
      <button id="export-type-transaction" onclick="showExportType('transaction')"><i class="fas fa-exchange-alt"></i> Transaction History</button>
      <button id="export-type-usage" onclick="showExportType('usage')"><i class="fas fa-chart-bar"></i> Usage Summary</button>
      <button id="export-type-audit" onclick="showExportType('audit')"><i class="fas fa-file-pdf"></i> Detailed Audit</button>
    </div>
    
    <!-- Export Content Area -->
    <div id="exportContent">
      <!-- Current Stock Export -->
      <div id="exportCurrentOption" style="padding: 0 20px;">
        <div style="background: rgba(5, 150, 105, 0.1); padding: 15px; border-radius: var(--radius-md); margin-bottom: 20px;">
          <p style="margin: 0; color: var(--accent-secondary); font-weight: 600;">
            <i class="fas fa-info-circle"></i> Export current inventory stock levels
          </p>
        </div>
        <p style="margin-bottom: 15px;">Includes: Sticker details, stock status, costs, and last usage information.</p>
        <button class="export-btn" onclick="exportCurrentStockCSV()" style="width: 100%; padding: 14px;">
          <i class="fas fa-file-csv"></i> Export Current Stock Report (CSV)
        </button>
      </div>
      
      <!-- Transaction History Export -->
      <div id="exportTransactionOption" style="display: none; padding: 0 20px;">
        <div style="background: rgba(67, 56, 202, 0.1); padding: 15px; border-radius: var(--radius-md); margin-bottom: 20px;">
          <p style="margin: 0; color: var(--accent-primary); font-weight: 600;">
            <i class="fas fa-info-circle"></i> Export transaction history for a specific period
          </p>
        </div>
        <div class="form-group" style="display: flex; gap: 12px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 150px;">
            <label for="exportTxStartDate"><i class="fas fa-calendar-start"></i> Start Date</label>
            <input type="date" id="exportTxStartDate" style="width: 100%;">
          </div>
          <div style="flex: 1; min-width: 150px;">
            <label for="exportTxEndDate"><i class="fas fa-calendar-end"></i> End Date</label>
            <input type="date" id="exportTxEndDate" style="width: 100%;">
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="export-btn" onclick="exportTransactionHistoryCSV()" style="flex: 1;">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
          <button class="export-btn" onclick="exportTransactionHistoryPDF()" style="flex: 1; background: linear-gradient(135deg, var(--accent-danger), #991b1b);">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
        </div>
      </div>
      
      <!-- Usage Summary Export -->
      <div id="exportUsageOption" style="display: none; padding: 0 20px;">
        <div style="background: rgba(217, 119, 6, 0.1); padding: 15px; border-radius: var(--radius-md); margin-bottom: 20px;">
          <p style="margin: 0; color: var(--accent-tertiary); font-weight: 600;">
            <i class="fas fa-info-circle"></i> Export usage summary by label and department
          </p>
        </div>
        <div class="form-group">
          <label for="exportUsagePeriod"><i class="fas fa-calendar-alt"></i> Select Period</label>
          <select id="exportUsagePeriod" style="width: 100%;">
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="last-month">Last Month</option>
            <option value="all">All Time</option>
            <option value="custom">Custom Date Range</option>
          </select>
        </div>
        <div id="exportCustomDates" style="display: none;">
          <div class="form-group" style="display: flex; gap: 12px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 150px;">
              <label for="exportUsageStartDate"><i class="fas fa-calendar-start"></i> Start Date</label>
              <input type="date" id="exportUsageStartDate" style="width: 100%;">
            </div>
            <div style="flex: 1; min-width: 150px;">
              <label for="exportUsageEndDate"><i class="fas fa-calendar-end"></i> End Date</label>
              <input type="date" id="exportUsageEndDate" style="width: 100%;">
            </div>
          </div>
        </div>
        <button class="export-btn" onclick="exportUsageSummaryCSV()" style="width: 100%; padding: 14px; margin-top: 15px;">
          <i class="fas fa-file-csv"></i> Export Usage Summary (CSV)
        </button>
      </div>
      
      <!-- Detailed Audit Export -->
      <div id="exportAuditOption" style="display: none; padding: 0 20px;">
        <div style="background: rgba(220, 38, 38, 0.1); padding: 15px; border-radius: var(--radius-md); margin-bottom: 20px;">
          <p style="margin: 0; color: var(--accent-danger); font-weight: 600;">
            <i class="fas fa-info-circle"></i> Export detailed audit report with all transactions
          </p>
        </div>
        <div class="form-group" style="display: flex; gap: 12px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 150px;">
            <label for="exportAuditStartDate"><i class="fas fa-calendar-start"></i> Start Date</label>
            <input type="date" id="exportAuditStartDate" style="width: 100%;">
          </div>
          <div style="flex: 1; min-width: 150px;">
            <label for="exportAuditEndDate"><i class="fas fa-calendar-end"></i> End Date</label>
            <input type="date" id="exportAuditEndDate" style="width: 100%;">
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="export-btn" onclick="exportDetailedAuditCSV()" style="flex: 1;">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
          <button class="export-btn" onclick="exportDetailedAuditPDF()" style="flex: 1; background: linear-gradient(135deg, var(--accent-danger), #991b1b);">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
        </div>
      </div>
    </div>
    
    <div style="margin: 30px 20px 20px 20px;">
      <button onclick="hideExportModal()" class="action-btn del-btn" style="width: 100%;"><i class="fas fa-times"></i> Close</button>
    </div>
  </div>
</div>

<!-- Transaction History Modal -->
<div id="transactionHistoryModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideTransactionHistoryModal()" aria-label="Close Transaction Log Modal">&times;</button>
    <h3><i class="fas fa-clipboard-list"></i> Transaction History (Audit Log)</h3>
    
    <!-- Date Filter -->
    <div style="margin: 20px 20px 0;">
      <div class="form-group" style="display: flex; gap: 12px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 150px;">
          <label for="txStartDate"><i class="fas fa-calendar-start"></i> Start Date</label>
          <input type="date" id="txStartDate" style="width: 100%;">
        </div>
        <div style="flex: 1; min-width: 150px;">
          <label for="txEndDate"><i class="fas fa-calendar-end"></i> End Date</label>
          <input type="date" id="txEndDate" style="width: 100%;">
        </div>
        <div style="display: flex; align-items: end;">
          <button class="action-btn" onclick="renderTransactionHistory()" style="height: 48px; padding: 0 16px;"><i class="fas fa-filter"></i> Apply</button>
        </div>
      </div>
    </div>

    <!-- Transaction Table -->
    <div id="transactionHistoryContent" style="margin-top: 20px; max-height: 50vh; overflow-y: auto;">
      <!-- Populated by JS -->
    </div>
    
    <div style="margin: 20px;">
      <button class="export-btn" onclick="exportTransactionHistoryCSV()" style="width: 100%;"><i class="fas fa-file-csv"></i> Export This View to CSV</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  const firebaseConfig = {
    apiKey: "AIzaSyDak-WfWfFGZG4TCrIsN0fS-2UFkKmmx8M",
    authDomain: "sticker-stocks.firebaseapp.com",
    projectId: "sticker-stocks",
    storageBucket: "sticker-stocks.firebasestorage.app",
    messagingSenderId: "641798479255",
    appId: "1:641798479255:web:ccb1fc59f930cc934e78d2",
    measurementId: "G-7TDVLLRFCV"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  // Expose to global scope for non-module script
  window.firebaseApp = app;
  window.firestore = { db, doc, getDoc, setDoc };
</script>
<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
<script>
  // --- USER/ADMIN CONTROL ---
  let userRole = null;
  document.getElementById("loginForm").onsubmit = function(e) {
    e.preventDefault();
    const pass = document.getElementById("loginPassword").value;
    if(pass === "Superb@123") setRole("admin");
    else if(pass === "1234") setRole("user");
    else {
      document.getElementById("loginError").style.display = "block";
      setTimeout(() => document.getElementById("loginError").style.display = "none", 2500);
      document.getElementById("loginPassword").value = "";
      document.getElementById("loginPassword").focus();
    }
  };
  function setRole(role) {
    userRole = role;
    document.getElementById("loginModal").style.display = "none";
    applyRolePermissions();
  }
  function applyRolePermissions() {
    if (userRole === null) return;
    const isAdmin = userRole === "admin";
    document.querySelectorAll(".admin-only").forEach(el => { if (el) el.style.display = isAdmin ? "" : "none"; });
    document.querySelectorAll(".admin-price").forEach(el => { if (el) el.style.display = isAdmin ? "" : "none"; });
    ["stickerName","stickerLabel","initialStock","stickerCost"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !isAdmin;
    });
    const ths = document.querySelectorAll("#reportTable th");
    if (ths.length > 8 && ths[8]) ths[8].style.display = isAdmin ? "" : "none";
    document.querySelectorAll("#reportTable tbody tr").forEach(row => {
      if (row.children.length > 8 && row.children[8]) row.children[8].style.display = isAdmin ? "" : "none";
      if (row.children.length > 4) {
        if(row.children[4]) row.children[4].style.display = isAdmin ? "" : "none";
        if(row.children[5]) row.children[5].style.display = isAdmin ? "" : "none";
      }
    });
  }
  // --- DARK MODE ---
  function setDark(dark) {
    if(dark) {
        document.documentElement.classList.add('dark');
        document.getElementById('darkToggleBtn').innerHTML = '<i class="fas fa-sun"></i>';
        document.getElementById('darkToggleBtn').title = "Switch to Light Mode";
        document.getElementById('darkToggleBtn').setAttribute('aria-label', 'Switch to Light Mode');
    } else {
        document.documentElement.classList.remove('dark');
        document.getElementById('darkToggleBtn').innerHTML = '<i class="fas fa-moon"></i>';
        document.getElementById('darkToggleBtn').title = "Switch to Dark Mode";
        document.getElementById('darkToggleBtn').setAttribute('aria-label', 'Switch to Dark Mode');
    }
    localStorage.setItem("sticker-inv-ultra-dark", dark ? "1" : "0");
  }
  document.getElementById('darkToggleBtn').onclick = function() {
    setDark(!document.documentElement.classList.contains('dark'));
  };
  (function(){
    const saved = localStorage.getItem("sticker-inv-ultra-dark");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    setDark(saved === "1" || (!saved && prefersDark));
  })();
  // ====== FIREBASE DATA LAYER ======
  let inventory = [];
  let editIndex = -1, addStockIndex = -1, usageModalIndex = -1;
  function showLoader(show=true) {
    document.getElementById('loader').style.display = show ? 'flex' : 'none';
  }
  async function loadInventory() {
    showLoader(true);
    try {
      const docRef = window.firestore.doc(window.firestore.db, "inventory", "main");
      const docSnap = await window.firestore.getDoc(docRef);
      inventory = docSnap.exists() ? docSnap.data().items || [] : [];
      
      // === DATA MIGRATION for older inventories ===
      inventory.forEach(item => {
        if (!item.transactions || !Array.isArray(item.transactions)) {
          item.transactions = [];
          // Reconstruct from initial stock + usage
          let balance = item.totalStock;
          // First, log initial add
          if (item.totalStock > 0) {
            item.transactions.push({
              type: "add",
              amount: item.totalStock,
              balance: item.totalStock,
              date: "2000-01-01",
              time: "00:00",
              person: "System",
              invoice: "MIGRATED"
            });
          }
          // Then replay usage as deductions (in order)
          if (Array.isArray(item.usage)) {
            item.usage.forEach(u => {
              balance -= u.amount;
              item.transactions.push({
                type: "deduct",
                amount: u.amount,
                balance: balance,
                date: u.date,
                time: u.time || "00:00",
                person: u.person,
                department: u.department
              });
            });
          }
          // Fix remainingStock if mismatched
          if (balance !== item.remainingStock) {
            console.warn("Balance mismatch fixed for:", item.name);
            item.remainingStock = balance;
          }
        }
      });
      
    } catch (err) {
      console.error("Load from Firebase failed:", err);
      inventory = [];
      alert('Could not load inventory data. Starting fresh.');
    } finally {
      showLoader(false);
    }
  }
  async function saveInventory() {
    showLoader(true);
    try {
      const docRef = window.firestore.doc(window.firestore.db, "inventory", "main");
      await window.firestore.setDoc(docRef, { items: inventory });
    } catch (err) {
      console.error("Save to Firebase failed:", err);
      alert('Could not save inventory data.');
    } finally {
      showLoader(false);
    }
  }
  // --- INVENTORY FUNCTIONS ---
  function addSticker() {
    const name = document.getElementById("stickerName").value.trim();
    const label = document.getElementById("stickerLabel").value;
    const stock = parseInt(document.getElementById("initialStock").value);
    const cost = parseFloat(document.getElementById("stickerCost").value) || 0;
    if (!name || !label || isNaN(stock) || stock < 0) {
      alert("Please enter valid sticker name, label and stock."); return;
    }
    if (inventory.some(s => s.name && s.name.toLowerCase() === name.toLowerCase())) {
      alert('Sticker with this name already exists.'); return;
    }
    
    const now = new Date();
    const dateString = now.toISOString().split('T')[0];
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    inventory.push({
      name, label, totalStock: stock, remainingStock: stock,
      costPerSticker: cost, usage: [],
      transactions: [{
        type: "add",
        amount: stock,
        balance: stock,
        date: dateString,
        time: timeString,
        person: "System",
        invoice: "INITIAL"
      }]
    });
    saveInventory().then(() => {
      updateSelectors();
      updateReport();
      clearStickerForm();
    });
  }
  function clearStickerForm() {
    document.getElementById("stickerName").value = "";
    document.getElementById("stickerLabel").value = "";
    document.getElementById("initialStock").value = "";
    document.getElementById("stickerCost").value = "";
    document.getElementById("addStickerBtn").disabled = true;
  }
  function editSticker(i) {
    editIndex = i;
    let s = inventory[i];
    document.getElementById("stickerName").value = s.name;
    document.getElementById("stickerLabel").value = s.label || "";
    document.getElementById("initialStock").value = s.totalStock;
    document.getElementById("stickerCost").value = s.costPerSticker;
    document.getElementById("addStickerBtn").textContent = "‚úèÔ∏è Update Sticker";
    document.getElementById("addStickerBtn").onclick = updateSticker;
    document.getElementById("addStickerBtn").disabled = false;
  }
  function updateSticker() {
    if (editIndex < 0) return;
    const name = document.getElementById("stickerName").value.trim();
    const label = document.getElementById("stickerLabel").value;
    const stock = parseInt(document.getElementById("initialStock").value);
    const cost = parseFloat(document.getElementById("stickerCost").value) || 0;
    if (!name || !label || isNaN(stock) || stock < 0) {
      alert("Please enter valid sticker name, label and stock."); return;
    }
    if (inventory.some((s, idx) => idx !== editIndex && s.name && s.name.toLowerCase() === name.toLowerCase())) {
      alert('Sticker with this name already exists.'); return;
    }
    let s = inventory[editIndex];
    s.name = name; s.label = label; s.totalStock = stock;
    let used = s.totalStock - s.remainingStock;
    s.remainingStock = Math.max(0, stock - used);
    s.costPerSticker = cost;
    saveInventory().then(() => {
      editIndex = -1;
      updateSelectors();
      updateReport();
      document.getElementById("addStickerBtn").textContent = "‚ûï Add Sticker";
      document.getElementById("addStickerBtn").onclick = addSticker;
      clearStickerForm();
    });
  }
  function deleteSticker(i) {
    if (!confirm("‚ö†Ô∏è Delete sticker and ALL usage records?")) return;
    inventory.splice(i, 1);
    saveInventory().then(() => {
      updateSelectors();
      updateReport();
    });
  }
  function deductStock() {
    const deductBtn = document.getElementById("deductBtn");
    if (!deductBtn || deductBtn.disabled) return;
    deductBtn.disabled = true;
    if (inventory.length === 0) {
      alert("No stickers in inventory.");
      deductBtn.disabled = false;
      return;
    }
    const index = parseInt(document.getElementById("selectSticker").value);
    const department = document.getElementById("department").value;
    const person = document.getElementById("person").value.trim();
    const date = document.getElementById("deductDate").value;
    const amount = parseInt(document.getElementById("deductAmount").value);
    if (isNaN(index) || index < 0 || index >= inventory.length || !department || !person || !date || isNaN(amount) || amount <= 0) {
      alert("Please fill in all fields correctly.");
      deductBtn.disabled = false;
      return;
    }
    const item = inventory[index];
    if (amount > item.remainingStock) {
      alert(`Not enough stock. Only ${item.remainingStock} left.`);
      deductBtn.disabled = false;
      return;
    }
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    item.remainingStock -= amount;
    item.usage.push({ department, amount, person, date, time: timeString });
    
    // ALSO log to transactions
    if (!item.transactions) item.transactions = [];
    item.transactions.push({
      type: "deduct",
      amount: amount,
      balance: item.remainingStock,
      date: date,
      time: timeString,
      person: person,
      department: department
    });
    
    saveInventory().then(() => {
      updateReport();
      document.getElementById("selectSticker").value = "";
      document.getElementById("department").value = "";
      document.getElementById("person").value = "";
      document.getElementById("deductDate").value = new Date().toISOString().split('T')[0];
      document.getElementById("deductAmount").value = "";
    }).catch(error => {
        console.error("Error saving deduction:", error);
        alert("An error occurred. The deduction might not have been saved.");
    }).finally(() => {
        if (deductBtn) {
            deductBtn.disabled = false;
            validateDeduct();
        }
    });
  }
  function updateSelectors() {
    const select = document.getElementById("selectSticker");
    select.innerHTML = "";
    let placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "--Select Sticker--";
    select.appendChild(placeholder);
    inventory.forEach((item, index) => {
      const option = document.createElement("option");
      option.value = index;
      option.textContent = item.label || item.name || 'Sticker';
      select.appendChild(option);
    });
    applyRolePermissions();
  }
  function updateReport() {
    const reportTableBody = document.querySelector("#reportTable tbody");
    reportTableBody.innerHTML = "";
    if (inventory.length === 0) {
      reportTableBody.innerHTML = `<tr><td colspan="9" class="text-center" style="padding: 40px; font-size: 1.2rem;">No sticker data available. Please add a new sticker.</td></tr>`;
      return;
    }
    inventory.forEach((item, index) => {
      const row = reportTableBody.insertRow();
      let totalUsed = 0;
      let lastUsedDate = "N/A";
      let lastUsedPerson = "N/A";
      let lastUsedTime = "N/A";
      if (item.usage && item.usage.length > 0) {
        totalUsed = item.usage.reduce((sum, u) => sum + u.amount, 0);
        const sortedUsage = [...item.usage].sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          if (dateA.getTime() !== dateB.getTime()) return dateB.getTime() - dateA.getTime();
          if (a.time && b.time) return b.time.localeCompare(a.time);
          return b.amount - a.amount;
        });
        const lastUsage = sortedUsage[0];
        lastUsedDate = lastUsage.date;
        lastUsedPerson = lastUsage.person;
        lastUsedTime = lastUsage.time || "N/A";
      }
      let rowClass = "";
      if (item.remainingStock === 0) rowClass = "out-stock";
      else if (item.remainingStock <= 5) rowClass = "low-stock";
      if (rowClass) row.classList.add(rowClass);
      row.innerHTML = `
        <td style="font-weight: 500;">${item.label || item.name || 'N/A'}</td>
        <td>${totalUsed}</td>
        <td style="font-weight: 600;">${item.remainingStock}</td>
        <td>${item.totalStock}</td>
        <td class="admin-price">R${item.costPerSticker ? item.costPerSticker.toFixed(2) : '0.00'}</td>
        <td class="admin-price">R${(item.totalStock * (item.costPerSticker || 0)).toFixed(2)}</td>
        <td>${lastUsedDate}<br><small style="opacity: 0.8;">${lastUsedTime}</small></td>
        <td>${lastUsedPerson}</td>
        <td class="admin-only">
          <button class="action-btn eye-btn" onclick="showUsageModal(${index})" title="View Usage Log"><i class="fas fa-eye"></i></button>
          <button class="action-btn" onclick="showAddStockModal(${index})" title="Add Stock"><i class="fas fa-plus"></i></button>
          <button class="action-btn edit-btn" onclick="editSticker(${index})" title="Edit Sticker"><i class="fas fa-edit"></i></button>
          <button class="action-btn del-btn" onclick="deleteSticker(${index})" title="Delete Sticker"><i class="fas fa-trash"></i></button>
        </td>
      `;
    });
    applyRolePermissions();
  }
  function showAddStockModal(i) {
    addStockIndex = i;
    document.getElementById('addStockStickerName').textContent = inventory[i].label || inventory[i].name;
    document.getElementById('addStockAmount').value = "";
    document.getElementById('addStockPerson').value = "";
    document.getElementById('addStockInvoice').value = "";
    document.getElementById('addStockModal').style.display = 'flex';
    setTimeout(()=>{document.getElementById('addStockPerson').focus()},250);
  }
  function hideAddStockModal() {
    document.getElementById('addStockModal').style.display = 'none';
    addStockIndex = -1;
  }
  function addStockToSticker() {
    const amt = parseInt(document.getElementById('addStockAmount').value);
    const person = document.getElementById('addStockPerson').value.trim();
    const invoice = document.getElementById('addStockInvoice').value.trim();

    if (isNaN(amt) || amt <= 0) { alert("Enter a valid amount."); return; }
    if (!person) { alert("Please enter the name of the person adding stock."); return; }
    if (!invoice) { alert("Please enter an invoice number."); return; }

    const now = new Date();
    const dateString = now.toISOString().split('T')[0];
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    const item = inventory[addStockIndex];
    const newBalance = item.remainingStock + amt;

    item.totalStock += amt;
    item.remainingStock = newBalance;

    if (!item.transactions) item.transactions = [];
    item.transactions.push({
      type: "add",
      amount: amt,
      balance: newBalance,
      date: dateString,
      time: timeString,
      person: person,
      invoice: invoice
    });

    saveInventory().then(() => {
      updateReport();
      hideAddStockModal();
    });
  }
  function showUsageModal(idx) {
    usageModalIndex = idx;
    const sticker = inventory[idx];
    let html = "";
    if (sticker.usage && sticker.usage.length) {
      html += `<table id="usageListTable"><thead><tr>
        <th>Date</th><th>Time</th><th>Person</th><th>Dept</th><th>Amt</th>
        <th class="admin-only">Actions</th>
      </tr></thead><tbody>`;
      sticker.usage.slice().reverse().forEach(u => {
        html += `<tr>
          <td>${u.date}</td>
          <td>${u.time || 'N/A'}</td>
          <td>${u.person}</td>
          <td>${u.department.charAt(0).toUpperCase() + u.department.slice(1)}</td>
          <td>${u.amount}</td>
          <td class="admin-only">
            <button class="action-btn del-btn" onclick="deleteUsage(${idx}, '${u.date}', '${u.time || ''}', '${u.person}', '${u.department}', ${u.amount})" title="Delete Usage"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
      });
      html += "</tbody></table>";
    } else {
      html = `<p class="text-center" style="font-size: 1.1rem; padding: 20px;">No usage log found for this sticker.</p>`;
    }
    document.getElementById('usageListContent').innerHTML = html;
    document.getElementById('usageModal').style.display = 'flex';
  }
  function hideUsageModal() {
    document.getElementById('usageModal').style.display = 'none';
    usageModalIndex = -1;
  }
  function deleteUsage(stickerIndex, date, time, person, department, amount) {
    if (!confirm("Delete this usage record?")) return;
    if (userRole !== "admin") {
      alert("Only admins can delete usage records.");
      return;
    }
    const sticker = inventory[stickerIndex];
    const usageIndex = sticker.usage.findIndex(u =>
      u.date === date &&
      u.time === time &&
      u.person === person &&
      u.department === department &&
      u.amount === amount
    );
    if (usageIndex !== -1) {
      sticker.usage.splice(usageIndex, 1);
      sticker.remainingStock += amount;
      
      // Also remove from transactions
      const txIndex = sticker.transactions.findIndex(t =>
        t.type === "deduct" &&
        t.date === date &&
        t.time === time &&
        t.person === person &&
        t.department === department &&
        t.amount === amount
      );
      if (txIndex !== -1) {
        sticker.transactions.splice(txIndex, 1);
        // Recalculate balances if needed (optional, for safety)
      }
      
      saveInventory().then(() => {
        updateReport();
        showUsageModal(stickerIndex);
      });
    }
  }
  
  // ====== FULL PAGE STATISTICS DASHBOARD ======
  function showFullPageStats() {
    document.getElementById('fullPageStats').style.display = 'block';
    showFullStatsTab('daily');
  }
  
  function hideFullPageStats() {
    document.getElementById('fullPageStats').style.display = 'none';
  }
  
  function refreshFullStats() {
    const activeTab = document.querySelector('#fullStatsTabs button.active');
    const tabId = activeTab ? activeTab.id.replace('full-tab-', '') : 'daily';
    showFullStatsTab(tabId);
  }
  
  function showFullStatsTab(tab) {
    // Update active tab
    ['daily', 'weekly', 'monthly', 'last-month', 'last-week', 'all'].forEach(x => {
      document.getElementById('full-tab-' + x).classList.remove('active');
    });
    document.getElementById('full-tab-' + tab).classList.add('active');
    
    // Calculate date range
    let now = new Date();
    let startDate, endDate, periodName;
    
    if (tab === "daily") {
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      periodName = "Today";
    } else if (tab === "weekly") {
      const day = now.getDay() || 7;
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      periodName = "This Week";
    } else if (tab === "monthly") {
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      periodName = "This Month";
    } else if (tab === "last-month") {
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), 1);
      periodName = "Last Month";
    } else if (tab === "last-week") {
      const day = now.getDay() || 7;
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1 - 7);
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1);
      periodName = "Last Week";
    } else if (tab === "all") {
      startDate = new Date(2000, 0, 1);
      endDate = new Date(now.getFullYear() + 10, 0, 1);
      periodName = "All Time";
    }
    
    // Collect comprehensive statistics
    const stats = calculateComprehensiveStats(startDate, endDate);
    
    // Build full-page stats HTML
    let html = '';
    
    if (stats.totalTransactions === 0) {
      html = `
        <div class="empty-state" style="padding: 100px 20px;">
          <i class="fas fa-chart-network" style="font-size: 4rem;"></i>
          <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">No Usage Data</h3>
          <p>No sticker usage recorded for ${periodName.toLowerCase()}.</p>
          <p style="margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);">
            Try selecting a different time period.
          </p>
        </div>
      `;
    } else {
      // Top summary cards
      html += `
        <div class="full-stats-grid">
          <div class="full-stat-item">
            <div class="full-stat-label">Total Used</div>
            <div class="full-stat-number">${stats.totalUsed}</div>
            <div class="full-stat-unit">stickers</div>
          </div>
          <div class="full-stat-item">
            <div class="full-stat-label">Departments</div>
            <div class="full-stat-number">${stats.departmentsCount}</div>
            <div class="full-stat-unit">active</div>
          </div>
          <div class="full-stat-item">
            <div class="full-stat-label">Label Types</div>
            <div class="full-stat-number">${stats.labelsCount}</div>
            <div class="full-stat-unit">used</div>
          </div>
          ${userRole === "admin" ? `
          <div class="full-stat-item">
            <div class="full-stat-label">Total Cost</div>
            <div class="full-stat-number">R${stats.totalCost.toFixed(2)}</div>
            <div class="full-stat-unit">spent</div>
          </div>
          ` : ''}
          <div class="full-stat-item">
            <div class="full-stat-label">Transactions</div>
            <div class="full-stat-number">${stats.totalTransactions}</div>
            <div class="full-stat-unit">records</div>
          </div>
          <div class="full-stat-item">
            <div class="full-stat-label">Avg Daily</div>
            <div class="full-stat-number">${stats.averageDailyUsage}</div>
            <div class="full-stat-unit">stickers/day</div>
          </div>
        </div>
      `;
      
      // Department Usage Chart
      const topDepts = Object.keys(stats.departmentStats)
        .sort((a, b) => stats.departmentStats[b].used - stats.departmentStats[a].used)
        .slice(0, 8);
      const maxDeptUsage = topDepts.length > 0 ? 
        Math.max(...topDepts.map(dept => stats.departmentStats[dept].used)) : 0;
      
      html += `
        <div class="full-stats-container">
          <!-- Department Usage Card -->
          <div class="full-stats-card wide">
            <div class="stats-header">
              <i class="fas fa-building"></i>
              <h4>Department Usage</h4>
            </div>
            
            ${topDepts.length > 0 ? `
            <div class="full-chart-container">
              <div class="full-bar-chart">
                ${topDepts.map(dept => {
                  const usage = stats.departmentStats[dept].used;
                  const percentage = maxDeptUsage > 0 ? (usage / maxDeptUsage * 100) : 0;
                  const shortName = dept.length > 12 ? dept.substring(0, 10) + '..' : dept;
                  return `
                    <div class="full-bar" style="height: ${percentage}%" 
                         title="${dept}: ${usage} stickers (${((usage / stats.totalUsed) * 100).toFixed(1)}%)">
                      <div class="full-bar-label">${shortName}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <table class="full-data-table">
              <thead>
                <tr>
                  <th>Department</th>
                  <th>Used</th>
                  <th>% of Total</th>
                  ${userRole === "admin" ? '<th>Cost</th>' : ''}
                </tr>
              </thead>
              <tbody>
                ${Object.keys(stats.departmentStats)
                  .sort((a, b) => stats.departmentStats[b].used - stats.departmentStats[a].used)
                  .map(dept => {
                    const percentage = stats.totalUsed > 0 ? ((stats.departmentStats[dept].used / stats.totalUsed) * 100).toFixed(1) : 0;
                    return `
                      <tr>
                        <td style="font-weight: 600;">${dept.charAt(0).toUpperCase() + dept.slice(1)}</td>
                        <td style="font-weight: 700;">${stats.departmentStats[dept].used}</td>
                        <td style="color: var(--accent-secondary); font-weight: 600;">${percentage}%</td>
                        ${userRole === "admin" ? `<td style="font-weight: 600;">R${stats.departmentStats[dept].cost.toFixed(2)}</td>` : ''}
                      </tr>
                    `;
                  }).join('')}
              </tbody>
            </table>
            ` : `
            <div class="empty-state" style="padding: 40px;">
              <i class="fas fa-building"></i>
              <p>No department usage data</p>
            </div>
            `}
          </div>
          
          <!-- Label Usage Card -->
          <div class="full-stats-card wide">
            <div class="stats-header">
              <i class="fas fa-tags"></i>
              <h4>Label Type Usage</h4>
            </div>
            
            ${stats.topLabels.length > 0 ? `
            <div class="full-chart-container">
              <div class="full-bar-chart">
                ${stats.topLabels.slice(0, 8).map(label => {
                  const usage = stats.labelUsedStats[label];
                  const percentage = stats.maxLabelUsage > 0 ? (usage / stats.maxLabelUsage * 100) : 0;
                  const shortName = label.length > 12 ? label.substring(0, 10) + '..' : label;
                  return `
                    <div class="full-bar" style="height: ${percentage}%; background: linear-gradient(to top, var(--accent-secondary), #047857);" 
                         title="${label}: ${usage} stickers">
                      <div class="full-bar-label">${shortName}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <table class="full-data-table">
              <thead>
                <tr>
                  <th>Label</th>
                  <th>Used</th>
                  <th>% of Total</th>
                  <th>Avg Daily</th>
                </tr>
              </thead>
              <tbody>
                ${stats.sortedLabels.map(label => {
                  const percentage = stats.totalUsed > 0 ? ((stats.labelUsedStats[label] / stats.totalUsed) * 100).toFixed(1) : 0;
                  const avgDaily = stats.daysInPeriod > 0 ? (stats.labelUsedStats[label] / stats.daysInPeriod).toFixed(1) : stats.labelUsedStats[label];
                  return `
                    <tr>
                      <td style="font-weight: 600;">${label}</td>
                      <td style="font-weight: 700;">${stats.labelUsedStats[label]}</td>
                      <td style="color: var(--accent-secondary); font-weight: 600;">${percentage}%</td>
                      <td style="color: var(--accent-tertiary); font-weight: 600;">${avgDaily}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
            ` : `
            <div class="empty-state" style="padding: 40px;">
              <i class="fas fa-tags"></i>
              <p>No label usage data</p>
            </div>
            `}
          </div>
          
          <!-- Daily Trends Card -->
          <div class="full-stats-card">
            <div class="stats-header">
              <i class="fas fa-chart-line"></i>
              <h4>Daily Trends</h4>
            </div>
            
            <div class="stats-metric">
              <span class="metric-label"><i class="fas fa-fire"></i> Peak Day</span>
              <span class="metric-value">${stats.peakDay.usage} (${stats.peakDay.date})</span>
            </div>
            
            <div class="stats-metric">
              <span class="metric-label"><i class="fas fa-calculator"></i> Average Daily</span>
              <span class="metric-value">${stats.averageDailyUsage}</span>
            </div>
            
            <div class="stats-metric">
              <span class="metric-label"><i class="fas fa-calendar-check"></i> Active Days</span>
              <span class="metric-value">${stats.activeDays}</span>
            </div>
            
            ${userRole === "admin" && stats.daysInPeriod > 1 ? `
            <div class="stats-metric">
              <span class="metric-label"><i class="fas fa-money-bill-wave"></i> Daily Cost Avg</span>
              <span class="metric-value">R${(stats.totalCost / stats.daysInPeriod).toFixed(2)}</span>
            </div>
            ` : ''}
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
              <p style="color: var(--text-secondary); font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Based on ${stats.daysInPeriod} days in period
              </p>
            </div>
          </div>
          
          <!-- Department Comparison Card -->
          <div class="full-stats-card">
            <div class="stats-header">
              <i class="fas fa-balance-scale"></i>
              <h4>Department Comparison</h4>
            </div>
            
            <div class="comparison-grid">
              ${Object.keys(stats.departmentStats)
                .sort((a, b) => stats.departmentStats[b].used - stats.departmentStats[a].used)
                .slice(0, 4)
                .map(dept => {
                  const usage = stats.departmentStats[dept].used;
                  const percentage = stats.totalUsed > 0 ? ((usage / stats.totalUsed) * 100).toFixed(1) : 0;
                  return `
                    <div class="comparison-card">
                      <h5 style="margin: 0 0 10px 0; color: var(--accent-primary);">${dept.charAt(0).toUpperCase() + dept.slice(1)}</h5>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 2rem; font-weight: 800; color: var(--accent-primary);">${usage}</span>
                        <span style="background: rgba(67, 56, 202, 0.1); color: var(--accent-primary); padding: 4px 8px; border-radius: var(--radius-sm); font-weight: 600;">${percentage}%</span>
                      </div>
                      <div style="margin-top: 10px; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-primary-hover));"></div>
                      </div>
                    </div>
                  `;
                }).join('')}
            </div>
          </div>
          
          <!-- Detailed Breakdown Card -->
          <div class="full-stats-card wide">
            <div class="stats-header">
              <i class="fas fa-list-ol"></i>
              <h4>Detailed Breakdown</h4>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 20px;">
              <div>
                <h5 style="margin: 0 0 15px 0; color: var(--accent-primary); font-size: 1.1rem;">
                  <i class="fas fa-chart-pie"></i> Usage Distribution
                </h5>
                ${Object.keys(stats.departmentStats)
                  .sort((a, b) => stats.departmentStats[b].used - stats.departmentStats[a].used)
                  .map(dept => {
                    const percentage = stats.totalUsed > 0 ? ((stats.departmentStats[dept].used / stats.totalUsed) * 100).toFixed(1) : 0;
                    return `
                      <div class="stats-metric">
                        <span class="metric-label">
                          <i class="fas fa-circle" style="color: var(--accent-primary); font-size: 0.7rem;"></i> ${dept}
                        </span>
                        <span class="metric-value">${percentage}%</span>
                      </div>
                    `;
                  }).join('')}
              </div>
              
              <div>
                <h5 style="margin: 0 0 15px 0; color: var(--accent-primary); font-size: 1.1rem;">
                  <i class="fas fa-tachometer-alt"></i> Performance Metrics
                </h5>
                <div class="stats-metric">
                  <span class="metric-label"><i class="fas fa-bolt"></i> Usage Rate</span>
                  <span class="metric-value">${stats.averageDailyUsage}/day</span>
                </div>
                <div class="stats-metric">
                  <span class="metric-label"><i class="fas fa-layer-group"></i> Coverage</span>
                  <span class="metric-value">${((stats.activeDays / stats.daysInPeriod) * 100).toFixed(0)}% days active</span>
                </div>
                <div class="stats-metric">
                  <span class="metric-label"><i class="fas fa-project-diagram"></i> Diversity</span>
                  <span class="metric-value">${stats.labelsCount} labels</span>
                </div>
                ${userRole === "admin" ? `
                <div class="stats-metric">
                  <span class="metric-label"><i class="fas fa-money-bill"></i> Efficiency</span>
                  <span class="metric-value">R${(stats.totalCost / stats.totalUsed).toFixed(3)}/sticker</span>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Export Section -->
        <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid var(--border-color);">
          <div style="text-align: center;">
            <h3 style="color: var(--accent-primary); margin-bottom: 20px;">
              <i class="fas fa-download"></i> Export Full Report
            </h3>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <button class="export-btn" onclick="exportFullStatsReport('${tab}', '${startDate.toISOString()}', '${endDate.toISOString()}')">
                <i class="fas fa-file-csv"></i> Export CSV Report
              </button>
              <button class="export-btn" onclick="exportFullStatsPDF('${tab}', '${startDate.toISOString()}', '${endDate.toISOString()}')" style="background: linear-gradient(135deg, var(--accent-danger), #991b1b);">
                <i class="fas fa-file-pdf"></i> Export PDF Report
              </button>
            </div>
            <p style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9rem;">
              <i class="fas fa-info-circle"></i> Period: ${periodName} (${formatDateRange(startDate, endDate)})
            </p>
          </div>
        </div>
      `;
    }
    
    document.getElementById('fullStatsContent').innerHTML = html;
  }
  
  function calculateComprehensiveStats(startDate, endDate) {
    let departmentStats = {};
    let labelUsedStats = {};
    let dailyUsage = {};
    let totalUsed = 0;
    let totalCost = 0;
    let totalTransactions = 0;
    let departments = new Set();
    let labels = new Set();
    
    // Calculate days in period
    const daysInPeriod = Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)));
    
    inventory.forEach(item => {
      item.usage.forEach(u => {
        let usageDate = new Date(u.date);
        if (usageDate >= startDate && usageDate < endDate) {
          // Department stats
          if (!departmentStats[u.department]) departmentStats[u.department] = { used: 0, cost: 0 };
          departmentStats[u.department].used += u.amount;
          departmentStats[u.department].cost += u.amount * (item.costPerSticker || 0);
          
          // Label stats
          const label = item.label || item.name;
          if (!labelUsedStats[label]) labelUsedStats[label] = 0;
          labelUsedStats[label] += u.amount;
          
          // Daily usage stats
          const dateKey = u.date;
          if (!dailyUsage[dateKey]) dailyUsage[dateKey] = 0;
          dailyUsage[dateKey] += u.amount;
          
          // Totals
          totalUsed += u.amount;
          totalCost += u.amount * (item.costPerSticker || 0);
          totalTransactions++;
          departments.add(u.department);
          labels.add(label);
        }
      });
    });
    
    // Find peak day
    let peakDay = { date: "N/A", usage: 0 };
    Object.keys(dailyUsage).forEach(date => {
      if (dailyUsage[date] > peakDay.usage) {
        peakDay = { date, usage: dailyUsage[date] };
      }
    });
    
    // Calculate averages
    const activeDays = Object.keys(dailyUsage).length;
    const averageDailyUsage = activeDays > 0 ? (totalUsed / activeDays).toFixed(1) : "0.0";
    
    // Sort labels by usage
    const sortedLabels = Object.keys(labelUsedStats).sort((a, b) => 
      labelUsedStats[b] - labelUsedStats[a]
    );
    
    const topLabels = sortedLabels.slice(0, 10);
    const maxLabelUsage = topLabels.length > 0 ? 
      Math.max(...topLabels.map(label => labelUsedStats[label])) : 0;
    
    return {
      totalUsed,
      totalCost,
      totalTransactions,
      departmentsCount: departments.size,
      labelsCount: labels.size,
      departmentStats,
      labelUsedStats,
      sortedLabels,
      topLabels,
      maxLabelUsage,
      dailyUsage,
      peakDay,
      activeDays,
      daysInPeriod,
      averageDailyUsage
    };
  }
  
  function formatDateRange(startDate, endDate) {
    const formatDate = (date) => {
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };
    
    const endDateForDisplay = new Date(endDate.getTime() - 86400000);
    return `${formatDate(startDate)} to ${formatDate(endDateForDisplay)}`;
  }
  
  function exportFullStatsReport(tab, startDateISO, endDateISO) {
    const startDate = new Date(startDateISO);
    const endDate = new Date(endDateISO);
    const stats = calculateComprehensiveStats(startDate, endDate);
    
    const periodNames = {
      'daily': 'Today',
      'weekly': 'This Week',
      'monthly': 'This Month',
      'last-week': 'Last Week',
      'last-month': 'Last Month',
      'all': 'All Time'
    };
    
    let csv = `FULL STATISTICS REPORT - ${periodNames[tab]}\n`;
    csv += `Period: ${formatDateRange(startDate, endDate)}\n`;
    csv += `Generated: ${new Date().toLocaleString()}\n\n`;
    
    csv += "SUMMARY\n";
    csv += `Total Stickers Used,${stats.totalUsed}\n`;
    csv += `Total Cost,R${stats.totalCost.toFixed(2)}\n`;
    csv += `Total Transactions,${stats.totalTransactions}\n`;
    csv += `Active Departments,${stats.departmentsCount}\n`;
    csv += `Label Types Used,${stats.labelsCount}\n`;
    csv += `Active Days,${stats.activeDays}/${stats.daysInPeriod}\n`;
    csv += `Average Daily Usage,${stats.averageDailyUsage}\n`;
    csv += `Peak Day,${stats.peakDay.date} (${stats.peakDay.usage} stickers)\n\n`;
    
    csv += "DEPARTMENT USAGE DETAILS\n";
    csv += "Department,Stickers Used,Total Cost,Percentage\n";
    Object.keys(stats.departmentStats)
      .sort((a, b) => stats.departmentStats[b].used - stats.departmentStats[a].used)
      .forEach(dept => {
        const percentage = stats.totalUsed > 0 ? ((stats.departmentStats[dept].used / stats.totalUsed) * 100).toFixed(2) : 0;
        csv += `"${dept}",${stats.departmentStats[dept].used},R${stats.departmentStats[dept].cost.toFixed(2)},${percentage}%\n`;
      });
    
    csv += "\nLABEL TYPE USAGE DETAILS\n";
    csv += "Label,Stickers Used,Percentage,Avg Daily\n";
    stats.sortedLabels.forEach(label => {
      const percentage = stats.totalUsed > 0 ? ((stats.labelUsedStats[label] / stats.totalUsed) * 100).toFixed(2) : 0;
      const avgDaily = stats.daysInPeriod > 0 ? (stats.labelUsedStats[label] / stats.daysInPeriod).toFixed(2) : stats.labelUsedStats[label];
      csv += `"${label}",${stats.labelUsedStats[label]},${percentage}%,${avgDaily}\n`;
    });
    
    csv += "\nDAILY USAGE BREAKDOWN\n";
    csv += "Date,Stickers Used\n";
    Object.keys(stats.dailyUsage)
      .sort()
      .forEach(date => {
        csv += `${date},${stats.dailyUsage[date]}\n`;
      });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `full_stats_${tab}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }
  
  function exportFullStatsPDF(tab, startDateISO, endDateISO) {
    const startDate = new Date(startDateISO);
    const endDate = new Date(endDateISO);
    const stats = calculateComprehensiveStats(startDate, endDate);
    
    const periodNames = {
      'daily': 'Today',
      'weekly': 'This Week',
      'monthly': 'This Month',
      'last-week': 'Last Week',
      'last-month': 'Last Month',
      'all': 'All Time'
    };
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(20);
    doc.setTextColor(67, 56, 202);
    doc.text('Full Statistics Report', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text(`Period: ${periodNames[tab]} (${formatDateRange(startDate, endDate)})`, 105, 30, { align: 'center' });
    doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 36, { align: 'center' });
    
    // Summary Section
    doc.setFontSize(14);
    doc.setTextColor(67, 56, 202);
    doc.text('Summary', 14, 50);
    
    const summaryData = [
      ['Total Stickers Used', stats.totalUsed],
      ['Total Cost', `R${stats.totalCost.toFixed(2)}`],
      ['Total Transactions', stats.totalTransactions],
      ['Active Departments', stats.departmentsCount],
      ['Label Types Used', stats.labelsCount],
      ['Average Daily Usage', stats.averageDailyUsage]
    ];
    
    doc.autoTable({
      startY: 55,
      head: [['Metric', 'Value']],
      body: summaryData,
      theme: 'grid',
      headStyles: { fillColor: [67, 56, 202] },
      styles: { fontSize: 10 }
    });
    
    // Department Usage
    const deptData = Object.keys(stats.departmentStats)
      .sort((a, b) => stats.departmentStats[b].used - stats.departmentStats[a].used)
      .map(dept => [
        dept,
        stats.departmentStats[dept].used,
        `R${stats.departmentStats[dept].cost.toFixed(2)}`,
        `${((stats.departmentStats[dept].used / stats.totalUsed) * 100).toFixed(1)}%`
      ]);
    
    doc.setFontSize(14);
    doc.setTextColor(67, 56, 202);
    doc.text('Department Usage', 14, doc.lastAutoTable.finalY + 10);
    
    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 15,
      head: [['Department', 'Used', 'Cost', '% of Total']],
      body: deptData,
      theme: 'grid',
      headStyles: { fillColor: [67, 56, 202] },
      styles: { fontSize: 9 }
    });
    
    // Save PDF
    doc.save(`full_stats_${tab}_${new Date().toISOString().split('T')[0]}.pdf`);
  }
  
  function exportFullStats() {
    const activeTab = document.querySelector('#fullStatsTabs button.active');
    const tabId = activeTab ? activeTab.id.replace('full-tab-', '') : 'daily';
    exportFullStatsReport(tabId, new Date(2000, 0, 1).toISOString(), new Date().toISOString());
  }
  
  // ====== ENHANCED STATS MODAL ======
  function showStatsModal() {
    document.getElementById('statsModal').style.display = 'flex';
    showStatsTab('daily');
  }
  
  function hideStatsModal() {
    document.getElementById('statsModal').style.display = 'none';
  }
  
  function showStatsTab(tab) {
    // Update active tab
    ['daily', 'weekly', 'monthly', 'last-month', 'last-week'].forEach(x => {
      document.getElementById('tab-' + x).classList.remove('active');
    });
    document.getElementById('tab-' + tab).classList.add('active');
    
    // Update period indicator
    const periodNames = {
      'daily': 'Today',
      'weekly': 'This Week',
      'monthly': 'This Month',
      'last-week': 'Last Week',
      'last-month': 'Last Month'
    };
    document.getElementById('periodIndicator').textContent = periodNames[tab];
    
    // Calculate date range
    let now = new Date();
    let startDate, endDate;
    if (tab === "daily") {
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
    } else if (tab === "weekly") {
      const day = now.getDay() || 7;
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
    } else if (tab === "monthly") {
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    } else if (tab === "last-month") {
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), 1);
    } else if (tab === "last-week") {
      const day = now.getDay() || 7;
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1 - 7);
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1);
    }
    
    // Collect statistics
    let departmentStats = {};
    let labelUsedStats = {};
    let totalUsed = 0;
    let totalCost = 0;
    let totalTransactions = 0;
    let departmentsWithUsage = new Set();
    let labelsWithUsage = new Set();
    
    inventory.forEach(item => {
      item.usage.forEach(u => {
        let d = new Date(u.date);
        if (d >= startDate && d < endDate) {
          // Department stats
          if (!departmentStats[u.department]) departmentStats[u.department] = { used: 0, cost: 0 };
          departmentStats[u.department].used += u.amount;
          departmentStats[u.department].cost += u.amount * (item.costPerSticker || 0);
          
          // Label stats
          const label = item.label || item.name;
          if (!labelUsedStats[label]) labelUsedStats[label] = 0;
          labelUsedStats[label] += u.amount;
          
          // Totals
          totalUsed += u.amount;
          totalCost += u.amount * (item.costPerSticker || 0);
          totalTransactions++;
          departmentsWithUsage.add(u.department);
          labelsWithUsage.add(label);
        }
      });
    });
    
    // Format dates for display
    const formatDate = (date) => {
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    };
    
    const periodDisplay = tab === 'daily' 
      ? formatDate(startDate)
      : tab === 'weekly' || tab === 'last-week'
      ? `${formatDate(startDate)} - ${formatDate(new Date(endDate.getTime() - 86400000))}`
      : startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    // Build enhanced stats HTML
    let html = '';
    
    if (totalTransactions === 0) {
      html = `
        <div class="empty-state">
          <i class="fas fa-chart-bar"></i>
          <h4 style="margin: 15px 0 10px; color: var(--text-secondary);">No Usage Data</h4>
          <p>No sticker usage recorded for ${periodNames[tab].toLowerCase()}.</p>
          <p style="margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);">
            Period: ${periodDisplay}
          </p>
        </div>
      `;
    } else {
      // Sort departments by usage (descending)
      const sortedDepartments = Object.keys(departmentStats).sort((a, b) => 
        departmentStats[b].used - departmentStats[a].used
      );
      
      // Sort labels by usage (descending)
      const sortedLabels = Object.keys(labelUsedStats).sort((a, b) => 
        labelUsedStats[b] - labelUsedStats[a]
      );
      
      // Top 5 departments for chart
      const topDepartments = sortedDepartments.slice(0, 5);
      const maxDeptUsage = topDepartments.length > 0 ? 
        Math.max(...topDepartments.map(dept => departmentStats[dept].used)) : 0;
      
      // Top 5 labels for chart
      const topLabels = sortedLabels.slice(0, 5);
      const maxLabelUsage = topLabels.length > 0 ? 
        Math.max(...topLabels.map(label => labelUsedStats[label])) : 0;
      
      html = `
        <div class="stats-container">
          <!-- Summary Card -->
          <div class="stats-card">
            <div class="stats-header">
              <i class="fas fa-chart-pie"></i>
              <h4>Summary</h4>
            </div>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">Total Used</div>
                <div class="stat-number">${totalUsed}</div>
                <div class="stat-unit">stickers</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Departments</div>
                <div class="stat-number">${departmentsWithUsage.size}</div>
                <div class="stat-unit">active</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Label Types</div>
                <div class="stat-number">${labelsWithUsage.size}</div>
                <div class="stat-unit">used</div>
              </div>
              ${userRole === "admin" ? `
              <div class="stat-item">
                <div class="stat-label">Total Cost</div>
                <div class="stat-number">R${totalCost.toFixed(2)}</div>
                <div class="stat-unit">spent</div>
              </div>
              ` : ''}
            </div>
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
              <div class="stats-metric">
                <span class="metric-label"><i class="fas fa-calendar-alt"></i> Period</span>
                <span class="metric-value">${periodDisplay}</span>
              </div>
              <div class="stats-metric">
                <span class="metric-label"><i class="fas fa-exchange-alt"></i> Transactions</span>
                <span class="metric-value">${totalTransactions}</span>
              </div>
            </div>
          </div>
          
          <!-- Top Departments Card -->
          <div class="stats-card">
            <div class="stats-header">
              <i class="fas fa-building"></i>
              <h4>Top Departments</h4>
            </div>
            
            ${topDepartments.length > 0 ? `
            <div class="chart-container">
              <div class="bar-chart">
                ${topDepartments.map(dept => {
                  const usage = departmentStats[dept].used;
                  const percentage = maxDeptUsage > 0 ? (usage / maxDeptUsage * 100) : 0;
                  const shortName = dept.length > 10 ? dept.substring(0, 8) + '..' : dept;
                  return `
                    <div class="bar" style="height: ${percentage}%" 
                         title="${dept}: ${usage} stickers">
                      <div class="bar-label">${shortName}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>Department</th>
                  <th>Used</th>
                  ${userRole === "admin" ? '<th>Cost</th>' : ''}
                </tr>
              </thead>
              <tbody>
                ${sortedDepartments.map(dept => `
                  <tr>
                    <td style="font-weight: 500;">${dept.charAt(0).toUpperCase() + dept.slice(1)}</td>
                    <td style="font-weight: 600;">${departmentStats[dept].used}</td>
                    ${userRole === "admin" ? `<td style="font-weight: 600;">R${departmentStats[dept].cost.toFixed(2)}</td>` : ''}
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ` : `
            <div class="empty-state" style="padding: 20px;">
              <i class="fas fa-building"></i>
              <p>No department usage data</p>
            </div>
            `}
          </div>
          
          <!-- Top Labels Card -->
          <div class="stats-card">
            <div class="stats-header">
              <i class="fas fa-tags"></i>
              <h4>Top Labels</h4>
            </div>
            
            ${topLabels.length > 0 ? `
            <div class="chart-container">
              <div class="bar-chart">
                ${topLabels.map(label => {
                  const usage = labelUsedStats[label];
                  const percentage = maxLabelUsage > 0 ? (usage / maxLabelUsage * 100) : 0;
                  const shortName = label.length > 10 ? label.substring(0, 8) + '..' : label;
                  return `
                    <div class="bar" style="height: ${percentage}%; background: linear-gradient(to top, var(--accent-secondary), #047857);" 
                         title="${label}: ${usage} stickers">
                      <div class="bar-label">${shortName}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>Label</th>
                  <th>Used</th>
                  <th>% of Total</th>
                </tr>
              </thead>
              <tbody>
                ${sortedLabels.map(label => {
                  const percentage = totalUsed > 0 ? ((labelUsedStats[label] / totalUsed) * 100).toFixed(1) : 0;
                  return `
                    <tr>
                      <td style="font-weight: 500;">${label}</td>
                      <td style="font-weight: 600;">${labelUsedStats[label]}</td>
                      <td style="font-weight: 600; color: var(--accent-secondary);">${percentage}%</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
            ` : `
            <div class="empty-state" style="padding: 20px;">
              <i class="fas fa-tags"></i>
              <p>No label usage data</p>
            </div>
            `}
          </div>
        </div>
        
        <!-- Export Button -->
        <div style="margin: 25px 20px 15px 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
          <button class="export-btn" onclick="exportStatsToCSV('${tab}', '${startDate.toISOString()}', '${endDate.toISOString()}')" style="width: 100%;">
            <i class="fas fa-file-csv"></i> Export ${periodNames[tab]} Statistics (CSV)
          </button>
        </div>
      `;
    }
    
    document.getElementById('statsContent').innerHTML = html;
  }
  
  // Export stats function
  function exportStatsToCSV(period, startDateISO, endDateISO) {
    const startDate = new Date(startDateISO);
    const endDate = new Date(endDateISO);
    
    let departmentStats = {};
    let labelUsedStats = {};
    let totalUsed = 0;
    let totalCost = 0;
    
    inventory.forEach(item => {
      item.usage.forEach(u => {
        let d = new Date(u.date);
        if (d >= startDate && d < endDate) {
          if (!departmentStats[u.department]) departmentStats[u.department] = { used: 0, cost: 0 };
          departmentStats[u.department].used += u.amount;
          departmentStats[u.department].cost += u.amount * (item.costPerSticker || 0);
          
          const label = item.label || item.name;
          if (!labelUsedStats[label]) labelUsedStats[label] = 0;
          labelUsedStats[label] += u.amount;
          
          totalUsed += u.amount;
          totalCost += u.amount * (item.costPerSticker || 0);
        }
      });
    });
    
    const periodNames = {
      'daily': 'Today',
      'weekly': 'This Week',
      'monthly': 'This Month',
      'last-week': 'Last Week',
      'last-month': 'Last Month'
    };
    
    let csv = `Sticker Usage Statistics - ${periodNames[period]}\n`;
    csv += `Period: ${startDate.toLocaleDateString()} to ${new Date(endDate.getTime() - 86400000).toLocaleDateString()}\n`;
    csv += `Generated: ${new Date().toLocaleString()}\n\n`;
    
    csv += "SUMMARY\n";
    csv += `Total Stickers Used,${totalUsed}\n`;
    csv += `Total Cost,R${totalCost.toFixed(2)}\n`;
    csv += `Number of Departments,${Object.keys(departmentStats).length}\n`;
    csv += `Number of Label Types,${Object.keys(labelUsedStats).length}\n\n`;
    
    csv += "DEPARTMENT USAGE\n";
    csv += "Department,Stickers Used,Total Cost\n";
    Object.keys(departmentStats).sort((a, b) => departmentStats[b].used - departmentStats[a].used).forEach(dept => {
      csv += `"${dept}",${departmentStats[dept].used},R${departmentStats[dept].cost.toFixed(2)}\n`;
    });
    
    csv += "\nLABEL USAGE\n";
    csv += "Label,Stickers Used,Percentage of Total\n";
    Object.keys(labelUsedStats).sort((a, b) => labelUsedStats[b] - labelUsedStats[a]).forEach(label => {
      const percentage = totalUsed > 0 ? ((labelUsedStats[label] / totalUsed) * 100).toFixed(2) : 0;
      csv += `"${label}",${labelUsedStats[label]},${percentage}%\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `stats_${period}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }
  
  // ====== SIMPLIFIED EXPORT SYSTEM ======
  
  // --- EXPORT MODAL FUNCTIONS ---
  function showExportModal() {
    // Set default dates
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const last30Days = new Date(now.setDate(now.getDate() - 30)).toISOString().split('T')[0];
    
    // Set default dates for all date inputs
    document.getElementById('exportTxStartDate').value = last30Days;
    document.getElementById('exportTxEndDate').value = todayStr;
    document.getElementById('exportAuditStartDate').value = last30Days;
    document.getElementById('exportAuditEndDate').value = todayStr;
    document.getElementById('exportUsageStartDate').value = todayStr;
    document.getElementById('exportUsageEndDate').value = todayStr;
    
    // Show current stock tab by default
    showExportType('current');
    document.getElementById('exportModal').style.display = 'flex';
  }
  
  function hideExportModal() {
    document.getElementById('exportModal').style.display = 'none';
  }
  
  function showExportType(type) {
    // Hide all options
    document.getElementById('exportCurrentOption').style.display = 'none';
    document.getElementById('exportTransactionOption').style.display = 'none';
    document.getElementById('exportUsageOption').style.display = 'none';
    document.getElementById('exportAuditOption').style.display = 'none';
    
    // Remove active class from all tabs
    document.querySelectorAll('#exportTypeTabs button').forEach(btn => btn.classList.remove('active'));
    
    // Show selected option and activate tab
    if (type === 'current') {
      document.getElementById('exportCurrentOption').style.display = 'block';
      document.getElementById('export-type-current').classList.add('active');
    } else if (type === 'transaction') {
      document.getElementById('exportTransactionOption').style.display = 'block';
      document.getElementById('export-type-transaction').classList.add('active');
    } else if (type === 'usage') {
      document.getElementById('exportUsageOption').style.display = 'block';
      document.getElementById('export-type-usage').classList.add('active');
      // Show/hide custom dates based on selection
      document.getElementById('exportUsagePeriod').addEventListener('change', function() {
        document.getElementById('exportCustomDates').style.display = 
          this.value === 'custom' ? 'block' : 'none';
      });
    } else if (type === 'audit') {
      document.getElementById('exportAuditOption').style.display = 'block';
      document.getElementById('export-type-audit').classList.add('active');
    }
  }
  
  // --- EXPORT CURRENT STOCK ---
  function exportCurrentStockCSV() {
    if (inventory.length === 0) {
      alert("No sticker data available.");
      return;
    }
    
    let csv = "Sticker Label,Sticker Name,Total Stock,Used Stock,Remaining Stock,Stock Status,Cost per Sticker (R),Total Cost (R),Last Used Date,Last Used By,Department\n";
    let totalRemaining = 0;
    let totalCostValue = 0;
    let outOfStockCount = 0;
    let lowStockCount = 0;
    
    inventory.forEach(item => {
      const used = item.totalStock - item.remainingStock;
      const totalCost = (item.totalStock * (item.costPerSticker || 0)).toFixed(2);
      let lastUsedDate = "Never";
      let lastUsedPerson = "N/A";
      let lastUsedDept = "N/A";
      
      // Determine stock status
      let stockStatus = "In Stock";
      if (item.remainingStock === 0) {
        stockStatus = "OUT OF STOCK";
        outOfStockCount++;
      } else if (item.remainingStock <= 5) {
        stockStatus = "LOW STOCK";
        lowStockCount++;
      }
      
      // Get last usage details
      if (item.usage && item.usage.length > 0) {
        const sortedUsage = [...item.usage].sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          if (dateA.getTime() !== dateB.getTime()) return dateB.getTime() - dateA.getTime();
          if (a.time && b.time) return b.time.localeCompare(a.time);
          return b.amount - a.amount;
        });
        lastUsedDate = sortedUsage[0].date;
        lastUsedPerson = sortedUsage[0].person;
        lastUsedDept = sortedUsage[0].department || "N/A";
      }
      
      csv += `"${item.label || 'N/A'}","${item.name || 'N/A'}","${item.totalStock}","${used}","${item.remainingStock}","${stockStatus}","${item.costPerSticker ? item.costPerSticker.toFixed(2) : '0.00'}","${totalCost}","${lastUsedDate}","${lastUsedPerson}","${lastUsedDept}"\n`;
      
      totalRemaining += item.remainingStock;
      totalCostValue += parseFloat(totalCost);
    });
    
    // Add summary section
    const now = new Date();
    const timestamp = now.toISOString().split('T')[0] + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    csv += `\nSUMMARY REPORT\n`;
    csv += `Total Sticker Types,${inventory.length}\n`;
    csv += `Total Remaining Stock,${totalRemaining}\n`;
    csv += `Total Inventory Value,R${totalCostValue.toFixed(2)}\n`;
    csv += `Out of Stock Items,${outOfStockCount}\n`;
    csv += `Low Stock Items (‚â§5),${lowStockCount}\n`;
    csv += `In Stock Items,${inventory.length - outOfStockCount - lowStockCount}\n`;
    csv += `Report Generated,${timestamp}\n`;
    
    // Create and download the file
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `sticker_inventory_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    hideExportModal();
  }
  
  // --- EXPORT TRANSACTION HISTORY ---
  function exportTransactionHistoryCSV() {
    const startDateStr = document.getElementById('exportTxStartDate').value;
    const endDateStr = document.getElementById('exportTxEndDate').value;
    
    if (!startDateStr || !endDateStr) {
      alert("Please select both start and end dates.");
      return;
    }
    
    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    endDate.setDate(endDate.getDate() + 1);
    
    const allTx = getAllTransactions();
    const filteredTx = allTx.filter(tx => {
      const txDate = new Date(tx.date);
      return txDate >= startDate && txDate < endDate;
    });
    
    if (filteredTx.length === 0) {
      alert("No transactions found in selected period.");
      return;
    }
    
    let csv = "Date,Time,Sticker,Type,Amount,Balance,Person,Invoice,Department\n";
    filteredTx.forEach(tx => {
      csv += `"${tx.date}","${tx.time}","${tx.sticker}","${tx.type.toUpperCase()}","${tx.amount}","${tx.balance}","${tx.person}","${tx.invoice}","${tx.department}"\n`;
    });
    
    // Add summary
    const added = filteredTx.filter(t => t.type === 'add').reduce((sum, t) => sum + t.amount, 0);
    const deducted = filteredTx.filter(t => t.type === 'deduct').reduce((sum, t) => sum + t.amount, 0);
    csv += `\nSUMMARY\n`;
    csv += `Total Transactions,${filteredTx.length}\n`;
    csv += `Total Added,${added}\n`;
    csv += `Total Deducted,${deducted}\n`;
    csv += `Net Change,${added - deducted}\n`;
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `transactions_${startDateStr}_to_${endDateStr}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    hideExportModal();
  }
  
  function exportTransactionHistoryPDF() {
    const startDateStr = document.getElementById('exportTxStartDate').value;
    const endDateStr = document.getElementById('exportTxEndDate').value;
    
    if (!startDateStr || !endDateStr) {
      alert("Please select both start and end dates.");
      return;
    }
    
    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    endDate.setDate(endDate.getDate() + 1);
    
    const allTx = getAllTransactions();
    const filteredTx = allTx.filter(tx => {
      const txDate = new Date(tx.date);
      return txDate >= startDate && txDate < endDate;
    });
    
    if (filteredTx.length === 0) {
      alert("No transactions found in selected period.");
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text(`Transaction History Report`, 14, 15);
    doc.setFontSize(12);
    doc.text(`Period: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`, 14, 25);
    
    const rows = filteredTx.map(tx => [
      tx.date,
      tx.time,
      tx.sticker,
      tx.type.toUpperCase(),
      tx.amount.toString(),
      tx.balance.toString(),
      tx.person,
      tx.invoice,
      tx.department
    ]);
    
    doc.autoTable({
      head: [["Date", "Time", "Sticker", "Type", "Amount", "Balance", "Person", "Invoice", "Dept"]],
      body: rows,
      startY: 35,
      styles: { fontSize: 8, cellPadding: 2 },
      headStyles: { fillColor: [67, 56, 202], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [248, 250, 252] }
    });
    
    doc.save(`transactions_${startDateStr}_to_${endDateStr}.pdf`);
    hideExportModal();
  }
  
  // --- EXPORT USAGE SUMMARY ---
  function exportUsageSummaryCSV() {
    const period = document.getElementById('exportUsagePeriod').value;
    let startDate, endDate;
    const now = new Date();
    
    if (period === 'custom') {
      const startDateStr = document.getElementById('exportUsageStartDate').value;
      const endDateStr = document.getElementById('exportUsageEndDate').value;
      
      if (!startDateStr || !endDateStr) {
        alert("Please select both start and end dates for custom period.");
        return;
      }
      
      startDate = new Date(startDateStr);
      endDate = new Date(endDateStr);
      endDate.setDate(endDate.getDate() + 1);
    } else {
      if (period === 'today') {
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      } else if (period === 'week') {
        const day = now.getDay() || 7;
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      } else if (period === 'month') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      } else if (period === 'last-month') {
        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), 1);
      } else if (period === 'all') {
        startDate = new Date(2000, 0, 1);
        endDate = new Date(now.getFullYear() + 10, 0, 1);
      }
    }
    
    const labelUsage = {};
    const deptUsage = {};
    let grandTotal = 0;
    
    inventory.forEach(item => {
      const label = item.label || item.name;
      item.usage.forEach(u => {
        let usageDate = new Date(u.date);
        usageDate.setHours(0, 0, 0, 0);
        if (usageDate >= startDate && usageDate < endDate) {
          // Label usage
          if (!labelUsage[label]) labelUsage[label] = 0;
          labelUsage[label] += u.amount;
          
          // Department usage
          const dept = u.department || 'Unknown';
          if (!deptUsage[dept]) deptUsage[dept] = 0;
          deptUsage[dept] += u.amount;
          
          grandTotal += u.amount;
        }
      });
    });
    
    if (grandTotal === 0) {
      alert("No usage data found for the selected period.");
      return;
    }
    
    let csv = "Usage Summary Report\n";
    csv += `Period: ${period === 'custom' ? `${startDate.toLocaleDateString()} to ${new Date(endDate.getTime() - 86400000).toLocaleDateString()}` : period}\n\n`;
    
    csv += "LABEL USAGE\n";
    csv += "Label,Total Used\n";
    Object.keys(labelUsage).sort().forEach(label => {
      csv += `"${label}",${labelUsage[label]}\n`;
    });
    
    csv += "\nDEPARTMENT USAGE\n";
    csv += "Department,Total Used\n";
    Object.keys(deptUsage).sort().forEach(dept => {
      csv += `"${dept.charAt(0).toUpperCase() + dept.slice(1)}",${deptUsage[dept]}\n`;
    });
    
    csv += `\nGRAND TOTAL,${grandTotal}\n`;
    csv += `Report Generated,${new Date().toLocaleString()}\n`;
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `usage_summary_${period}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    hideExportModal();
  }
  
  // --- EXPORT DETAILED AUDIT ---
  function exportDetailedAuditCSV() {
    const startDateStr = document.getElementById('exportAuditStartDate').value;
    const endDateStr = document.getElementById('exportAuditEndDate').value;
    
    if (!startDateStr || !endDateStr) {
      alert("Please select both start and end dates.");
      return;
    }
    
    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    endDate.setDate(endDate.getDate() + 1);
    
    const allTx = getAllTransactions();
    const filteredTx = allTx.filter(tx => {
      const txDate = new Date(tx.date);
      return txDate >= startDate && txDate < endDate;
    });
    
    if (filteredTx.length === 0) {
      alert("No transactions found in selected period.");
      return;
    }
    
    let csv = "Detailed Audit Report\n";
    csv += `Period: ${startDate.toLocaleDateString()} to ${new Date(endDate.getTime() - 86400000).toLocaleDateString()}\n\n`;
    
    csv += "Date,Time,Sticker Label,Transaction Type,Amount,Balance After,Person Responsible,Invoice Number,Department,Cost per Sticker (R),Total Cost (R)\n";
    
    let totalAdded = 0;
    let totalDeducted = 0;
    let totalCost = 0;
    
    filteredTx.forEach(tx => {
      const item = inventory.find(i => (i.label || i.name) === tx.sticker);
      const costPer = item ? item.costPerSticker || 0 : 0;
      const txCost = tx.type === 'add' ? tx.amount * costPer : 0;
      
      csv += `"${tx.date}","${tx.time}","${tx.sticker}","${tx.type.toUpperCase()}","${tx.amount}","${tx.balance}","${tx.person}","${tx.invoice}","${tx.department}","${costPer.toFixed(2)}","${txCost.toFixed(2)}"\n`;
      
      if (tx.type === 'add') {
        totalAdded += tx.amount;
        totalCost += txCost;
      } else {
        totalDeducted += tx.amount;
      }
    });
    
    csv += `\nSUMMARY\n`;
    csv += `Total Transactions,${filteredTx.length}\n`;
    csv += `Total Stock Added,${totalAdded}\n`;
    csv += `Total Stock Deducted,${totalDeducted}\n`;
    csv += `Net Stock Change,${totalAdded - totalDeducted}\n`;
    csv += `Total Cost of Additions,R${totalCost.toFixed(2)}\n`;
    csv += `Report Generated,${new Date().toLocaleString()}\n`;
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `audit_report_${startDateStr}_to_${endDateStr}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    hideExportModal();
  }
  
  function exportDetailedAuditPDF() {
    const startDateStr = document.getElementById('exportAuditStartDate').value;
    const endDateStr = document.getElementById('exportAuditEndDate').value;
    
    if (!startDateStr || !endDateStr) {
      alert("Please select both start and end dates.");
      return;
    }
    
    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    endDate.setDate(endDate.getDate() + 1);
    
    const allTx = getAllTransactions();
    const filteredTx = allTx.filter(tx => {
      const txDate = new Date(tx.date);
      return txDate >= startDate && txDate < endDate;
    });
    
    if (filteredTx.length === 0) {
      alert("No transactions found in selected period.");
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text(`Detailed Audit Report`, 14, 15);
    doc.setFontSize(12);
    doc.text(`Period: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`, 14, 25);
    
    let totalAdded = 0;
    let totalDeducted = 0;
    let totalCost = 0;
    
    const rows = filteredTx.map(tx => {
      const item = inventory.find(i => (i.label || i.name) === tx.sticker);
      const costPer = item ? item.costPerSticker || 0 : 0;
      const txCost = tx.type === 'add' ? tx.amount * costPer : 0;
      
      if (tx.type === 'add') {
        totalAdded += tx.amount;
        totalCost += txCost;
      } else {
        totalDeducted += tx.amount;
      }
      
      return [
        tx.date,
        tx.time,
        tx.sticker,
        tx.type.toUpperCase(),
        tx.amount.toString(),
        tx.balance.toString(),
        tx.person,
        tx.invoice,
        tx.department,
        "R" + costPer.toFixed(2),
        "R" + txCost.toFixed(2)
      ];
    });
    
    doc.autoTable({
      head: [["Date", "Time", "Sticker", "Type", "Amount", "Balance", "Person", "Invoice", "Dept", "Cost Each", "Total Cost"]],
      body: rows,
      startY: 35,
      styles: { fontSize: 7, cellPadding: 2 },
      headStyles: { fillColor: [67, 56, 202], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [248, 250, 252] }
    });
    
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text(`Summary: Added ${totalAdded}, Deducted ${totalDeducted}, Net: ${totalAdded - totalDeducted}`, 14, finalY);
    doc.text(`Total Cost: R${totalCost.toFixed(2)}`, 14, finalY + 5);
    
    doc.save(`audit_report_${startDateStr}_to_${endDateStr}.pdf`);
    hideExportModal();
  }
  
  // --- UTILITY FUNCTIONS ---
  function getAllTransactions() {
    const allTx = [];
    inventory.forEach(item => {
      const label = item.label || item.name || 'Unknown';
      if (Array.isArray(item.transactions)) {
        item.transactions.forEach(tx => {
          allTx.push({
            sticker: label,
            type: tx.type,
            amount: tx.amount,
            balance: tx.balance,
            date: tx.date,
            time: tx.time,
            person: tx.person || 'N/A',
            invoice: tx.invoice || '',
            department: tx.department || ''
          });
        });
      }
    });
    // Sort newest first
    return allTx.sort((a, b) => {
      const dateA = new Date(`${a.date}T${a.time}`);
      const dateB = new Date(`${b.date}T${b.time}`);
      return dateB - dateA;
    });
  }
  
  function downloadJSON() {
    const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventory, null, 2));
    const dlAnchor = document.createElement('a');
    dlAnchor.setAttribute("href", dataStr);
    dlAnchor.setAttribute("download", "sticker_inventory_backup.json");
    document.body.appendChild(dlAnchor);
    dlAnchor.click();
    document.body.removeChild(dlAnchor);
  }
  
  function uploadJSON(evt) {
    let file = evt.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
      try {
        let data = JSON.parse(e.target.result);
        if (Array.isArray(data)) {
          if (confirm("‚ö†Ô∏è This will REPLACE ALL current data. Continue?")) {
            inventory = data;
            saveInventory().then(() => {
              updateSelectors();
              updateReport();
              alert("Upload successful!");
            });
          }
        } else { alert("Invalid file format. Please upload a JSON file."); }
      } catch(err) { alert("Invalid file format. Please upload a valid JSON file."); }
    };
    reader.readAsText(file);
    evt.target.value = "";
  }
  
  function resetAllData() {
    if (!confirm("‚ö†Ô∏è DELETE ALL data permanently? This cannot be undone.")) return;
    inventory = [];
    saveInventory().then(() => {
      updateSelectors();
      updateReport();
    });
  }
  
  // === TRANSACTION HISTORY MODAL ===
  function showTransactionHistoryModal() {
    if (userRole !== "admin") return;
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const last30Days = new Date(now.setDate(now.getDate() - 30)).toISOString().split('T')[0];

    document.getElementById('txStartDate').value = last30Days;
    document.getElementById('txEndDate').value = todayStr;
    renderTransactionHistory();
    document.getElementById('transactionHistoryModal').style.display = 'flex';
  }

  function hideTransactionHistoryModal() {
    document.getElementById('transactionHistoryModal').style.display = 'none';
  }

  function renderTransactionHistory() {
    const startDateStr = document.getElementById('txStartDate').value;
    const endDateStr = document.getElementById('txEndDate').value;

    if (!startDateStr || !endDateStr) {
      alert("Please select both start and end dates.");
      return;
    }

    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    endDate.setDate(endDate.getDate() + 1);

    const allTx = getAllTransactions();
    const filteredTx = allTx.filter(tx => {
      const txDate = new Date(tx.date);
      return txDate >= startDate && txDate < endDate;
    });

    let html = '';
    if (filteredTx.length === 0) {
      html = `<p class="text-center" style="font-size: 1.1rem; padding: 25px;">No transactions found in selected period.</p>`;
    } else {
      html = `<table id="transactionTable" style="width:100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Sticker</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Balance</th>
            <th>Person</th>
            <th>Invoice</th>
            <th>Department</th>
          </tr>
        </thead>
        <tbody>`;
      filteredTx.forEach(tx => {
        html += `<tr>
          <td>${tx.date}</td>
          <td>${tx.time}</td>
          <td>${tx.sticker}</td>
          <td style="font-weight: 600; color: ${tx.type === 'add' ? 'var(--accent-secondary)' : 'var(--accent-danger)'};">
            ${tx.type === 'add' ? 'ADD' : 'DEDUCT'}
          </td>
          <td style="font-weight: 500;">${tx.amount}</td>
          <td style="font-weight: 600;">${tx.balance}</td>
          <td>${tx.person}</td>
          <td>${tx.invoice || '‚Äî'}</td>
          <td>${tx.department ? tx.department.charAt(0).toUpperCase() + tx.department.slice(1) : '‚Äî'}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
    }

    document.getElementById('transactionHistoryContent').innerHTML = html;
  }

  // --- FORM VALIDATION ---
  function validateAddSticker() {
    const name = document.getElementById("stickerName").value.trim();
    const label = document.getElementById("stickerLabel").value;
    const stock = parseInt(document.getElementById("initialStock").value);
    const cost = parseFloat(document.getElementById("stickerCost").value);
    document.getElementById("addStickerBtn").disabled = !(name && label && !isNaN(stock) && stock >= 0 && !isNaN(cost) && cost >= 0);
  }
  
  function validateDeduct() {
    const stickerIdx = document.getElementById("selectSticker").value;
    const dep = document.getElementById("department").value;
    const per = document.getElementById("person").value.trim();
    const date = document.getElementById("deductDate").value;
    const amt = parseInt(document.getElementById("deductAmount").value);
    document.getElementById("deductBtn").disabled = !(stickerIdx !== "" && dep && per && date && !isNaN(amt) && amt > 0 && inventory.length > 0);
  }
  
  ["stickerName", "stickerLabel", "initialStock", "stickerCost"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener("input", validateAddSticker);
        el.addEventListener("change", validateAddSticker);
    }
  });
  
  ["selectSticker", "department", "person", "deductDate", "deductAmount"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener("input", validateDeduct);
        el.addEventListener("change", validateDeduct);
    }
  });
  
  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', function() {
    const deductBtn = document.getElementById("deductBtn");
    if (deductBtn) {
        deductBtn.addEventListener("click", function() {
            if (!this.disabled) deductStock();
        });
    }
  });
  
  window.onload = async () => {
    showLoader(true);
    await loadInventory();
    updateSelectors();
    updateReport();
    document.getElementById("deductDate").value = new Date().toISOString().split('T')[0];
    showLoader(false);
    validateAddSticker();
    validateDeduct();
    document.getElementById("loginModal").style.display = "flex";
    document.getElementById("loginPassword").focus();
  };
</script>
</body>
</html>