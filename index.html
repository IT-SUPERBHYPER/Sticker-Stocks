<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Superb Sticker Inventory </title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè∑Ô∏è</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* ===== ULTRA HIGH-RES & EYE-POPPING THEME ===== */
    :root {
      /* Light Theme Vibrant Colors */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      /* Ultra-Vibrant Accent Colors */
      --accent-primary: #4338ca; /* Vibrant Indigo */
      --accent-primary-hover: #3730a3;
      --accent-secondary: #059669; /* Vibrant Emerald */
      --accent-tertiary: #d97706; /* Vibrant Amber */
      --accent-danger: #dc2626; /* Vibrant Red */
      --accent-info: #0ea5e9; /* Vibrant Sky Blue */
      /* Status Colors */
      --status-out: #fecaca; /* Red-200 */
      --status-out-text: #7f1d1d; /* Red-900 */
      --status-low: #fde68a; /* Amber-200 */
      --status-low-text: #78350f; /* Amber-900 */
      /* Radii & Transitions */
      --radius-xs: 4px;
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 24px;
      --transition-all: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --transition-fast: all 0.2s ease-in-out;
    }
    /* Dark Theme Overrides */
    html.dark {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --status-out: #7f1d1d; /* Red-900 */
      --status-out-text: #fecaca; /* Red-200 */
      --status-low: #78350f; /* Amber-900 */
      --status-low-text: #fde68a; /* Amber-200 */
    }
    /* ===== BASE STYLES & HIGH-RES ===== */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    html {
        font-size: 17px;
        scroll-behavior: smooth;
    }
    @media (min-resolution: 2dppx) {
        html { font-size: 18px; }
    }
    body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        min-height: 100vh;
        padding: 15px;
        background-image:
            radial-gradient(circle at 10% 20%, rgba(67, 56, 202, 0.08) 0%, transparent 25%),
            radial-gradient(circle at 90% 80%, rgba(5, 150, 105, 0.08) 0%, transparent 25%);
        background-attachment: fixed;
        transition: var(--transition-all);
    }
    html.dark body {
        background-image:
            radial-gradient(circle at 10% 20%, rgba(67, 56, 202, 0.15) 0%, transparent 25%),
            radial-gradient(circle at 90% 80%, rgba(5, 150, 105, 0.15) 0%, transparent 25%);
    }
    .container {
      max-width: 1100px;
      margin: 25px auto;
      background-color: var(--bg-card);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-2xl);
      padding: 35px;
      transition: var(--transition-all);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    .container::before {
        content: "";
        position: absolute;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: conic-gradient(
            from 0deg at 50% 50%,
            var(--accent-primary) 0deg,
            var(--accent-secondary) 120deg,
            var(--accent-tertiary) 240deg,
            var(--accent-primary) 360deg
        );
        opacity: 0;
        z-index: -2;
        animation: rotateHue 10s linear infinite;
        transition: opacity 0.8s ease;
    }
    .container:hover::before {
        opacity: 0.08;
    }
    .container::after {
        content: "";
        position: absolute;
        inset: 1px;
        background: var(--bg-card);
        border-radius: var(--radius-2xl);
        z-index: -1;
    }
    @keyframes rotateHue {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    /* Animations */
    @keyframes fadeInScale {
        from { opacity: 0; transform: translateY(30px) scale(0.97); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes slideInFromLeft {
        from { opacity: 0; transform: translateX(-40px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInFromRight {
        from { opacity: 0; transform: translateX(40px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
    }
    @keyframes pulseGlow {
        0% { box-shadow: 0 0 0 0 rgba(67, 56, 202, 0.5); }
        70% { box-shadow: 0 0 0 15px rgba(67, 56, 202, 0); }
        100% { box-shadow: 0 0 0 0 rgba(67, 56, 202, 0); }
    }
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    /* Headings */
    h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.8rem;
      font-weight: 900;
      text-align: center;
      margin-bottom: 25px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-tertiary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      animation: fadeInScale 0.9s ease-out;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    h1::after {
        content: "";
        display: block;
        width: 100px;
        height: 5px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        margin: 15px auto 0;
        border-radius: 3px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.7rem;
      font-weight: 800;
      color: var(--accent-primary);
      margin: 35px 0 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInFromLeft 0.7s ease-out;
      letter-spacing: -0.3px;
    }
    h2 i {
        font-size: 1.3em;
        flex-shrink: 0;
    }
    /* Layout & Controls */
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
      margin-bottom: 25px;
      animation: slideInFromRight 0.7s ease-out;
    }
    #darkToggleBtn {
      position: absolute;
      right: 20px;
      top: 20px;
      z-index: 100;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 50%;
      font-size: 1.5em;
      width: 55px; height: 55px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: var(--transition-all);
    }
    #darkToggleBtn:hover {
        transform: rotate(20deg) scale(1.15);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        box-shadow: var(--shadow-lg);
        background: var(--bg-secondary);
    }
    html.dark #darkToggleBtn {
        background: var(--bg-secondary);
    }
    /* Buttons - Eye-Popping */
    .action-btn, button, .reset-btn, .download-btn, .upload-btn {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      border-radius: var(--radius-md);
      border: none;
      padding: 12px 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition-all);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      font-size: 1.05rem;
      letter-spacing: 0.2px;
    }
    .action-btn::before, button::before {
        content: "";
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: 0.6s;
    }
    .action-btn:hover::before, button:hover::before {
        left: 100%;
    }
    .action-btn:active, button:active {
        transform: scale(0.96);
        transition: var(--transition-fast);
    }
    .action-btn:focus-visible, button:focus-visible {
        outline: 2px dashed var(--accent-info);
        outline-offset: 2px;
    }
    .action-btn:disabled {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
        box-shadow: var(--shadow-xs);
    }
    /* Specific Button Styles */
    button, .action-btn:not(.eye-btn, .edit-btn, .del-btn) {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        border: 1px solid var(--accent-primary-hover);
    }
    button:hover, .action-btn:not(.eye-btn, .edit-btn, .del-btn):hover {
        background: linear-gradient(135deg, var(--accent-primary-hover), var(--accent-primary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .action-btn.eye-btn {
        background-color: var(--bg-primary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }
    .action-btn.eye-btn:hover {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        border-color: var(--accent-primary);
        box-shadow: var(--shadow-md);
        transform: translateY(-3px);
    }
    .action-btn.edit-btn {
        background: linear-gradient(135deg, var(--accent-tertiary), #b45309);
        color: white;
        border: 1px solid #b45309;
    }
    .action-btn.edit-btn:hover {
        background: linear-gradient(135deg, #b45309, var(--accent-tertiary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .action-btn.del-btn, .reset-btn {
        background: linear-gradient(135deg, var(--accent-danger), #991b1b);
        color: white;
        border: 1px solid #991b1b;
    }
    .action-btn.del-btn:hover, .reset-btn:hover {
        background: linear-gradient(135deg, #991b1b, var(--accent-danger));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .download-btn {
        background: linear-gradient(135deg, var(--accent-secondary), #047857);
        color: white;
        border: 1px solid #047857;
    }
    .download-btn:hover {
        background: linear-gradient(135deg, #047857, var(--accent-secondary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    .upload-btn {
        background: linear-gradient(135deg, var(--accent-tertiary), #b45309);
        color: white;
        border: 1px solid #b45309;
    }
    .upload-btn:hover {
        background: linear-gradient(135deg, #b45309, var(--accent-tertiary));
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }
    /* Forms - High-Res & Friendly */
    .form-pair-group {
        display: flex;
        gap: 25px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        animation: fadeInScale 0.8s ease-out;
    }
    .form-group {
        flex: 1;
        min-width: 220px;
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
    }
    .form-group label {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 8px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 7px;
    }
    .form-group input, .form-group select {
        padding: 14px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 1.05rem;
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        transition: var(--transition-all);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        min-height: 50px;
    }
    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 4px rgba(67, 56, 202, 0.25);
        background-color: var(--bg-card);
    }
    html.dark .form-group input, html.dark .form-group select {
        background-color: var(--bg-primary);
    }
    /* Table - High-Res & Friendly */
    .table-responsive {
        overflow-x: auto;
        margin-top: 25px;
        animation: fadeInScale 0.9s ease-out;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: var(--bg-card);
        min-width: 800px;
    }
    th {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        font-weight: 700;
        text-align: center;
        padding: 18px 14px;
        font-size: 1.05rem;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        position: relative;
        overflow: hidden;
    }
    th::after {
        content: "";
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
        animation: shimmer 2s infinite;
    }
    td {
        padding: 16px 14px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        transition: var(--transition-all);
        font-size: 1rem;
    }
    tr:last-child td {
        border-bottom: none;
    }
    tr:nth-child(even) td {
        background-color: rgba(67, 56, 202, 0.02);
    }
    html.dark tr:nth-child(even) td {
        background-color: rgba(255, 255, 255, 0.03);
    }
    tr:hover td {
        background-color: rgba(67, 56, 202, 0.06);
        transform: scale(1.015);
        z-index: 1;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    html.dark tr:hover td {
        background-color: rgba(67, 56, 202, 0.12);
    }
    .out-stock td {
        background-color: var(--status-out) !important;
        color: var(--status-out-text);
        font-weight: 600;
    }
    .low-stock td {
        background-color: var(--status-low) !important;
        color: var(--status-low-text);
        font-weight: 600;
    }
    .total-col {
        font-weight: 700;
        color: var(--accent-primary);
    }
    /* Modals - High-Res & Friendly with Scrollable Content */
    #addStockModal, #usageModal, #statsModal, #exportDateSelectionModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.4s ease-out;
      backdrop-filter: blur(8px);
    }
    .modal-content {
      background-color: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2xl);
      width: 92%;
      max-width: 550px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      position: relative;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid var(--border-color);
    }
    .modal-content > div:not(.modal-header) {
        overflow-y: auto;
        flex-grow: 1;
        padding: 0 20px 20px 20px;
    }
    .modal-content h3 {
        margin: 0;
        padding: 25px 20px 15px 20px;
        flex-shrink: 0;
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--accent-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    @keyframes popIn {
        0% { opacity: 0; transform: scale(0.7); }
        100% { opacity: 1; transform: scale(1); }
    }
    .modal-close {
        position: absolute;
        top: 18px;
        right: 18px;
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: var(--text-secondary);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-all);
        z-index: 10;
    }
    .modal-close:hover {
        background-color: var(--border-color);
        color: var(--accent-danger);
        transform: rotate(90deg) scale(1.1);
        box-shadow: var(--shadow-sm);
    }
    #usageListTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        display: block;
        max-width: 100%;
        overflow-x: auto;
    }
    #usageListTable thead, #usageListTable tbody {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    #usageListTable th, #usageListTable td {
        padding: 14px 10px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
        word-wrap: break-word;
    }
    #usageListTable th {
        background-color: var(--bg-primary);
        color: var(--accent-primary);
        font-weight: 700;
        position: sticky;
        top: 0;
    }
    #usageListTable tr:last-child td {
        border-bottom: none;
    }
    #usageListTable tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.02);
    }
    html.dark #usageListTable tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.04);
    }
    /* Stats & Export Tabs */
    #statsTabs, #exportDateSelectionTabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 25px 20px 25px 20px;
        flex-shrink: 0;
    }
    #statsTabs button, #exportDateSelectionTabs button {
        background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 10px 17px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-all);
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }
    #statsTabs button.active, #exportDateSelectionTabs button.active,
    #statsTabs button:hover, #exportDateSelectionTabs button:hover {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
        color: white;
        border-color: var(--accent-primary);
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }
    #statsTable {
        width: 100%;
        border-collapse: collapse;
        display: block;
        max-width: 100%;
        overflow-x: auto;
        margin-bottom: 20px;
    }
    #statsTable thead, #statsTable tbody {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    #statsTable th, #statsTable td {
        padding: 14px 12px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
        word-wrap: break-word;
    }
    #statsTable th {
        background-color: var(--bg-primary);
        color: var(--accent-primary);
        font-weight: 700;
        position: sticky;
        top: 0;
    }
    /* Loader */
    #loader {
        display: none;
        position: fixed;
        z-index: 99999;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(255, 255, 255, 0.85);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
    }
    html.dark #loader {
        background-color: rgba(15, 23, 42, 0.9);
    }
    .loader-spinner {
        width: 60px;
        height: 60px;
        border: 6px solid var(--border-color);
        border-top: 6px solid var(--accent-primary);
        border-radius: 50%;
        animation: spin 1.2s linear infinite, pulseGlow 1.8s infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Login Modal */
    #loginModal {
        position: fixed;
        z-index: 999999;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #0f172a, #1e293b);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(15px);
    }
    #loginForm {
        background: var(--bg-card);
        padding: 45px;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-2xl);
        text-align: center;
        width: 90%;
        max-width: 450px;
        animation: float 4s ease-in-out infinite;
        border: 1px solid var(--border-color);
    }
    #loginForm h2 {
        justify-content: center;
        margin-top: 0;
        font-size: 2.2rem;
        margin-bottom: 25px;
        color: var(--accent-primary);
    }
    #loginForm input {
        width: 100%;
        padding: 16px;
        margin: 25px 0;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        font-size: 1.1rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: var(--transition-all);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    #loginForm input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 4px rgba(67, 56, 202, 0.25);
    }
    #loginForm button {
        width: 100%;
        padding: 14px;
        font-size: 1.2rem;
        margin-top: 10px;
    }
    #loginError {
        color: var(--accent-danger);
        margin-top: 20px;
        display: none;
        animation: shake 0.6s;
        font-weight: 500;
        padding: 12px;
        border-radius: var(--radius-sm);
        background-color: rgba(220, 38, 38, 0.1);
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-7px); }
        75% { transform: translateX(7px); }
    }
    /* Utility Classes */
    .text-center { text-align: center; }
    .mt-10 { margin-top: 10px; }
    .mb-10 { margin-bottom: 10px; }
    .ml-5 { margin-left: 5px; }
    /* Responsive - Mobile Friendly */
    @media (max-width: 1100px) {
        .container { max-width: 95%; }
    }
    @media (max-width: 768px) {
        html { font-size: 16px; }
        .container {
            padding: 25px 20px;
            margin: 15px auto;
            border-radius: var(--radius-xl);
        }
        .form-pair-group {
            flex-direction: column;
            gap: 0;
        }
        .form-group {
            min-width: 100%;
            margin-bottom: 18px;
        }
        h1 {
            font-size: 2.2rem;
            margin-bottom: 20px;
        }
        h1::after {
            width: 80px;
            height: 4px;
        }
        h2 {
            font-size: 1.5rem;
            margin: 30px 0 18px;
            gap: 10px;
        }
        .flex-row {
            gap: 8px;
            justify-content: center;
        }
        .action-btn, button, .reset-btn, .download-btn, .upload-btn {
            padding: 10px 14px;
            font-size: 0.95rem;
            gap: 6px;
        }
        th, td {
            padding: 12px 8px;
            font-size: 0.9rem;
        }
        #darkToggleBtn {
            right: 12px;
            top: 12px;
            width: 48px;
            height: 48px;
            font-size: 1.3em;
        }
        .modal-content {
            padding: 0;
            width: 95%;
            max-width: none;
            max-height: 95vh;
        }
        .modal-content h3 {
            font-size: 1.6rem;
            padding: 20px 15px 10px 15px;
        }
        .modal-close {
             top: 15px;
             right: 15px;
             width: 40px;
             height: 40px;
             font-size: 1.8rem;
        }
        #usageListTable th, #usageListTable td,
        #statsTable th, #statsTable td {
            padding: 10px 6px;
            font-size: 0.85rem;
        }
        #statsTabs, #exportDateSelectionTabs {
             margin: 20px 15px;
        }
        #statsTabs button, #exportDateSelectionTabs button {
             padding: 8px 12px;
             font-size: 0.9rem;
        }
        #loginForm {
            padding: 35px 25px;
            width: 95%;
        }
        #loginForm h2 {
            font-size: 1.9rem;
        }
        #loginForm input {
            padding: 14px;
            font-size: 1rem;
        }
    }
    @media (max-width: 480px) {
        html { font-size: 15px; }
        h1 { font-size: 1.9rem; }
        h2 { font-size: 1.3rem; }
        .container { padding: 20px 15px; }
        .form-group input, .form-group select {
            padding: 12px 14px;
            font-size: 1rem;
        }
        th, td {
            padding: 10px 5px;
            font-size: 0.82rem;
        }
        .action-btn, button, .reset-btn, .download-btn, .upload-btn {
            padding: 9px 12px;
            font-size: 0.9rem;
        }
        #darkToggleBtn {
            width: 42px;
            height: 42px;
        }
        .modal-content h3 {
             font-size: 1.4rem;
             padding: 18px 12px 8px 12px;
        }
        .modal-close {
             top: 12px;
             right: 12px;
             width: 38px;
             height: 38px;
             font-size: 1.7rem;
        }
        #usageListTable th, #usageListTable td,
        #statsTable th, #statsTable td {
             padding: 8px 4px;
             font-size: 0.8rem;
        }
        #statsTabs, #exportDateSelectionTabs {
             margin: 15px 10px;
             gap: 6px;
        }
        #statsTabs button, #exportDateSelectionTabs button {
             padding: 7px 10px;
             font-size: 0.85rem;
        }
    }
  </style>
</head>
<body>
<!-- Login Modal -->
<div id="loginModal">
  <form id="loginForm">
    <h2><i class="fas fa-lock"></i> Secure Login</h2>
    <input type="password" id="loginPassword" placeholder="Enter password..." autocomplete="current-password" autofocus>
    <button type="submit"><i class="fas fa-sign-in-alt"></i> Access Inventory</button>
    <div id="loginError"><i class="fas fa-exclamation-triangle"></i> Incorrect password. Please try again.</div>
  </form>
</div>
<!-- Dark Mode Toggle -->
<button id="darkToggleBtn" title="Toggle Theme" aria-label="Toggle Dark/Light Mode">
    <i class="fas fa-moon"></i>
</button>
<!-- Main Container -->
<div class="container">
  <h1><i class="fas fa-tags"></i> Superb Sticker Inventory </h1>
  <!-- Loader -->
  <div id="loader">
    <div class="loader-spinner"></div>
  </div>
  <!-- Action Buttons -->
  <div class="flex-row">
    <button onclick="showExportDateSelectionModal('csv')" title="Export Detailed Report (CSV)"><i class="fas fa-file-csv"></i> CSV</button>
    <button onclick="showExportDateSelectionModal('pdf')" title="Export Detailed Report (PDF)"><i class="fas fa-file-pdf"></i> PDF</button>
    <button onclick="showExportDateSelectionModal('labels_usage_csv')" title="Export Label Usage Summary"><i class="fas fa-chart-bar"></i> Labels CSV</button>
    <button class="download-btn" onclick="downloadJSON()" title="Backup Data Locally"><i class="fas fa-download"></i> Backup</button>
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Restore Data from Backup"><i class="fas fa-upload"></i> Restore</button>
    <button class="reset-btn" onclick="resetAllData()" title="‚ö†Ô∏è Delete All Data Permanently"><i class="fas fa-trash-alt"></i> Reset</button>
    <button onclick="showStatsModal()" title="View Usage Statistics"><i class="fas fa-chart-pie"></i> Stats</button>
    <input type="file" id="fileInput" accept=".json,.csv" style="display:none" onchange="uploadJSON(event)">
  </div>
  <!-- Add Sticker Form -->
  <h2><i class="fas fa-plus-circle"></i> Add New Sticker</h2>
  <form id="addStickerForm" onsubmit="event.preventDefault();">
    <div class="form-pair-group">
      <div class="form-group">
        <label for="stickerName"><i class="fas fa-font"></i> Sticker Name</label>
        <input type="text" id="stickerName" autocomplete="off" placeholder="e.g., Premium Barcode Sticker">
      </div>
      <div class="form-group">
        <label for="stickerLabel"><i class="fas fa-tag"></i> Sticker Label</label>
        <select id="stickerLabel">
          <option value="">-- Select Label --</option>
          <option value="SCALE LABELS (BW500)">SCALE LABELS (BW500)</option>
          <option value="CHICKEN LABELS">CHICKEN LABELS</option>
          <option value="BEEF LABELS">BEEF LABELS</option>
          <option value="MUTTON LABELS">MUTTON LABELS</option>
          <option value="MINCE LABELS">MINCE LABELS</option>
          <option value="SPECIAL OFFER (GREEN)">SPECIAL OFFER (GREEN)</option>
          <option value="SPECIAL OFFER (ORANGE)">SPECIAL OFFER (ORANGE)</option>
          <option value="BARCODE LABELS">BARCODE LABELS</option>
          <option value="ARROW LABELS">ARROW LABELS</option>
          <option value="SECURITY TAPE (RED)">SECURITY TAPE (RED)</option>
          <option value="SECURITY TAPE (BLUE)">SECURITY TAPE (BLUE)</option>
          <option value="SECURITY STICKERS (GREEN)">SECURITY STICKERS (GREEN)</option>
          <option value="SECURITY STICKERS (BLUE)">SECURITY STICKERS (BLUE)</option>
          <option value="SECURITY STICKERS (RED)">SECURITY STICKERS (RED)</option>
          <option value="COLOUR PAPER">COLOUR PAPER</option>
          <option value="INVOICE/REFERENCE STICKER">INVOICE/REFERENCE STICKER</option>
        </select>
      </div>
      <div class="form-group">
        <label for="initialStock"><i class="fas fa-boxes"></i> Initial Stock</label>
        <input type="number" id="initialStock" min="0" placeholder="e.g., 1000">
      </div>
      <div class="form-group">
        <label for="stickerCost"><i class="fas fa-coins"></i> Cost per Sticker (R)</label>
        <input type="number" id="stickerCost" step="0.01" min="0" placeholder="e.g., 0.75">
      </div>
    </div>
    <button type="button" id="addStickerBtn" onclick="addSticker()" disabled><i class="fas fa-plus"></i> Add Sticker</button>
  </form>
  <!-- Deduct Sticker Form -->
  <h2><i class="fas fa-minus-circle"></i> Deduct Sticker Usage</h2>
  <form onsubmit="event.preventDefault();">
    <div class="form-pair-group">
      <div class="form-group">
        <label for="selectSticker"><i class="fas fa-search"></i> Select Sticker</label>
        <select id="selectSticker">
          <option value="">-- Select Sticker --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="department"><i class="fas fa-building"></i> Department</label>
        <select id="department">
          <option value="">-- Select Department --</option>
          <option value="butchery">Butchery</option>
          <option value="spice">Spice</option>
          <option value="fruit and veg">Fruit and Veg</option>
          <option value="barcoding">Barcoding</option>
          <option value="online">Online</option>
          <option value="freezer">Freezer</option>
          <option value="retail">Retail</option>

        </select>
      </div>
      <div class="form-group">
        <label for="person"><i class="fas fa-user"></i> Person</label>
        <input type="text" id="person" placeholder="e.g., John Smith">
      </div>
      <div class="form-group">
        <label for="deductDate"><i class="fas fa-calendar-day"></i> Date of Use</label>
        <input type="date" id="deductDate">
      </div>
      <div class="form-group">
        <label for="deductAmount"><i class="fas fa-hashtag"></i> Deduct Amount</label>
        <input type="number" id="deductAmount" min="1" placeholder="e.g., 50">
      </div>
    </div>
    <button type="button" id="deductBtn" disabled><i class="fas fa-minus"></i> Deduct Stock</button>
  </form>
  <!-- Inventory Report Table -->
  <div class="table-responsive">
    <table id="reportTable">
      <thead>
        <tr>
          <th><i class="fas fa-tag"></i> Sticker Label</th>
          <th><i class="fas fa-arrow-up"></i> Used</th>
          <th><i class="fas fa-arrow-down"></i> Remaining</th>
          <th><i class="fas fa-box"></i> Total</th>
          <th class="admin-price"><i class="fas fa-money-bill-wave"></i> Cost Each</th>
          <th class="admin-price"><i class="fas fa-receipt"></i> Total Cost</th>
          <th><i class="fas fa-clock"></i> Last Use</th>
          <th><i class="fas fa-user"></i> Who</th>
          <th class="admin-only"><i class="fas fa-cogs"></i> Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data populated by JavaScript -->
      </tbody>
    </table>
  </div>
</div> <!-- End .container -->
<!-- Modals -->
<div id="addStockModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideAddStockModal()" aria-label="Close Add Stock Modal">&times;</button>
    <h3><i class="fas fa-plus-square"></i> Add Stock</h3>
    <div>
        <p id="addStockStickerName" style="font-weight:600; margin: 15px 0; font-size: 1.2rem;"></p>
        <div class="form-group">
            <label for="addStockAmount"><i class="fas fa-sort-numeric-up"></i> Amount to Add</label>
            <input type="number" id="addStockAmount" placeholder="Enter amount" min="1">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
          <button onclick="addStockToSticker()" style="flex:1;"><i class="fas fa-plus"></i> Add Stock</button>
          <button onclick="hideAddStockModal()" class="action-btn del-btn" style="flex:1;"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </div>
  </div>
</div>
<div id="usageModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideUsageModal()" aria-label="Close Usage Log Modal">&times;</button>
    <h3><i class="fas fa-history"></i> Sticker Usage Log</h3>
    <div id="usageListContent" style="margin-top: 20px;">
        <!-- Usage log populated by JavaScript -->
    </div>
  </div>
</div>
<div id="statsModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideStatsModal()" aria-label="Close Statistics Modal">&times;</button>
    <h3><i class="fas fa-chart-line"></i> Usage Statistics</h3>
    <div id="statsTabs">
      <button id="tab-daily" onclick="showStatsTab('daily')" class="active"><i class="fas fa-calendar-day"></i> Today</button>
      <button id="tab-weekly" onclick="showStatsTab('weekly')"><i class="fas fa-calendar-week"></i> This Week</button>
      <button id="tab-monthly" onclick="showStatsTab('monthly')"><i class="fas fa-calendar-alt"></i> This Month</button>
      <button id="tab-last-week" onclick="showStatsTab('last-week')"><i class="fas fa-step-backward"></i> Last Week</button>
      <button id="tab-last-month" onclick="showStatsTab('last-month')"><i class="fas fa-step-backward"></i> Last Month</button>
    </div>
    <div id="statsContent">
        <!-- Stats content populated by JavaScript -->
    </div>
  </div>
</div>
<div id="exportDateSelectionModal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideExportDateSelectionModal()" aria-label="Close Export Modal">&times;</button>
    <h3><i class="fas fa-file-export"></i> Select Export Period</h3>
    <div id="exportDateSelectionTabs" style="margin: 25px 0;">
      <button id="export-tab-month" onclick="showExportOption('month')" class="active"><i class="fas fa-calendar-alt"></i> By Month</button>
      <button id="export-tab-week" onclick="showExportOption('week')"><i class="fas fa-calendar-week"></i> By Week</button>
      <button id="export-tab-range" onclick="showExportOption('range')"><i class="fas fa-calendar-range"></i> By Date Range</button>
      <button id="export-tab-all" onclick="showExportOption('all')"><i class="fas fa-infinity"></i> All Data</button>
    </div>
    <div id="exportDateSelectionContent">
      <div id="exportMonthOption">
        <label for="exportMonth"><i class="fas fa-calendar-alt"></i> Select Month:</label>
        <input type="month" id="exportMonth" style="width: 100%; padding: 12px; margin-top: 8px; border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
      </div>
      <div id="exportWeekOption" style="display:none;">
        <label for="exportWeekStart"><i class="fas fa-calendar-start"></i> Start Date (Week):</label>
        <input type="date" id="exportWeekStart" style="width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 20px; border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
        <label for="exportWeekEnd"><i class="fas fa-calendar-end"></i> End Date (Week):</label>
        <input type="date" id="exportWeekEnd" style="width: 100%; padding: 12px; margin-top: 8px; border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
      </div>
      <div id="exportRangeOption" style="display:none;">
        <label for="exportRangeStart"><i class="fas fa-calendar-start"></i> Start Date:</label>
        <input type="date" id="exportRangeStart" style="width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 20px; border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
        <label for="exportRangeEnd"><i class="fas fa-calendar-end"></i> End Date:</label>
        <input type="date" id="exportRangeEnd" style="width: 100%; padding: 12px; margin-top: 8px; border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
      </div>
    </div>
    <div style="display: flex; gap: 12px; margin: 30px 20px 20px 20px;">
      <button id="confirmExportBtn" style="flex:1;"><i class="fas fa-file-export"></i> Export</button>
      <button onclick="hideExportDateSelectionModal()" class="action-btn del-btn" style="flex:1;"><i class="fas fa-times"></i> Cancel</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDak-WfWfFGZG4TCrIsN0fS-2UFkKmmx8M",
    authDomain: "sticker-stocks.firebaseapp.com",
    projectId: "sticker-stocks",
    storageBucket: "sticker-stocks.firebasestorage.app",
    messagingSenderId: "641798479255",
    appId: "1:641798479255:web:ccb1fc59f930cc934e78d2",
    measurementId: "G-7TDVLLRFCV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Expose to global scope for non-module script
  window.firebaseApp = app;
  window.firestore = { db, doc, getDoc, setDoc };
</script>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
<script>
  // --- USER/ADMIN CONTROL ---
  let userRole = null;
  document.getElementById("loginForm").onsubmit = function(e) {
    e.preventDefault();
    const pass = document.getElementById("loginPassword").value;
    if(pass === "Superb@123") setRole("admin");
    else if(pass === "1234") setRole("user");
    else {
      document.getElementById("loginError").style.display = "block";
      setTimeout(() => document.getElementById("loginError").style.display = "none", 2500);
      document.getElementById("loginPassword").value = "";
      document.getElementById("loginPassword").focus();
    }
  };
  function setRole(role) {
    userRole = role;
    document.getElementById("loginModal").style.display = "none";
    applyRolePermissions();
  }
  function applyRolePermissions() {
    if (userRole === null) return;
    const isAdmin = userRole === "admin";
    document.querySelectorAll(".admin-only").forEach(el => { if (el) el.style.display = isAdmin ? "" : "none"; });
    document.querySelectorAll(".admin-price").forEach(el => { if (el) el.style.display = isAdmin ? "" : "none"; });
    ["stickerName","stickerLabel","initialStock","stickerCost"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !isAdmin;
    });
    const ths = document.querySelectorAll("#reportTable th");
    if (ths.length > 8 && ths[8]) ths[8].style.display = isAdmin ? "" : "none";
    document.querySelectorAll("#reportTable tbody tr").forEach(row => {
      if (row.children.length > 8 && row.children[8]) row.children[8].style.display = isAdmin ? "" : "none";
      if (row.children.length > 4) {
        if(row.children[4]) row.children[4].style.display = isAdmin ? "" : "none";
        if(row.children[5]) row.children[5].style.display = isAdmin ? "" : "none";
      }
    });
  }
  // --- DARK MODE ---
  function setDark(dark) {
    if(dark) {
        document.documentElement.classList.add('dark');
        document.getElementById('darkToggleBtn').innerHTML = '<i class="fas fa-sun"></i>';
        document.getElementById('darkToggleBtn').title = "Switch to Light Mode";
        document.getElementById('darkToggleBtn').setAttribute('aria-label', 'Switch to Light Mode');
    } else {
        document.documentElement.classList.remove('dark');
        document.getElementById('darkToggleBtn').innerHTML = '<i class="fas fa-moon"></i>';
        document.getElementById('darkToggleBtn').title = "Switch to Dark Mode";
        document.getElementById('darkToggleBtn').setAttribute('aria-label', 'Switch to Dark Mode');
    }
    localStorage.setItem("sticker-inv-ultra-dark", dark ? "1" : "0");
  }
  document.getElementById('darkToggleBtn').onclick = function() {
    setDark(!document.documentElement.classList.contains('dark'));
  };
  (function(){
    const saved = localStorage.getItem("sticker-inv-ultra-dark");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    setDark(saved === "1" || (!saved && prefersDark));
  })();
  // ====== FIREBASE DATA LAYER ======
  let inventory = [];
  let editIndex = -1, addStockIndex = -1, usageModalIndex = -1;
  let exportType = '';
  let exportOption = 'month';

  function showLoader(show=true) {
    document.getElementById('loader').style.display = show ? 'flex' : 'none';
  }

  async function loadInventory() {
    showLoader(true);
    try {
      const docRef = window.firestore.doc(window.firestore.db, "inventory", "main");
      const docSnap = await window.firestore.getDoc(docRef);
      inventory = docSnap.exists() ? docSnap.data().items || [] : [];
    } catch (err) {
      console.error("Load from Firebase failed:", err);
      inventory = [];
      alert('Could not load inventory data. Starting fresh.');
    } finally {
      showLoader(false);
    }
  }

  async function saveInventory() {
    showLoader(true);
    try {
      const docRef = window.firestore.doc(window.firestore.db, "inventory", "main");
      await window.firestore.setDoc(docRef, { items: inventory });
    } catch (err) {
      console.error("Save to Firebase failed:", err);
      alert('Could not save inventory data.');
    } finally {
      showLoader(false);
    }
  }

  // --- INVENTORY FUNCTIONS (UNCHANGED) ---
  function addSticker() {
    const name = document.getElementById("stickerName").value.trim();
    const label = document.getElementById("stickerLabel").value;
    const stock = parseInt(document.getElementById("initialStock").value);
    const cost = parseFloat(document.getElementById("stickerCost").value) || 0;
    if (!name || !label || isNaN(stock) || stock < 0) {
      alert("Please enter valid sticker name, label and stock."); return;
    }
    if (inventory.some(s => s.name && s.name.toLowerCase() === name.toLowerCase())) {
      alert('Sticker with this name already exists.'); return;
    }
    inventory.push({
      name, label, totalStock: stock, remainingStock: stock,
      costPerSticker: cost, usage: []
    });
    saveInventory().then(() => {
      updateSelectors();
      updateReport();
      clearStickerForm();
    });
  }
  function clearStickerForm() {
    document.getElementById("stickerName").value = "";
    document.getElementById("stickerLabel").value = "";
    document.getElementById("initialStock").value = "";
    document.getElementById("stickerCost").value = "";
    document.getElementById("addStickerBtn").disabled = true;
  }
  function editSticker(i) {
    editIndex = i;
    let s = inventory[i];
    document.getElementById("stickerName").value = s.name;
    document.getElementById("stickerLabel").value = s.label || "";
    document.getElementById("initialStock").value = s.totalStock;
    document.getElementById("stickerCost").value = s.costPerSticker;
    document.getElementById("addStickerBtn").textContent = "‚úèÔ∏è Update Sticker";
    document.getElementById("addStickerBtn").onclick = updateSticker;
    document.getElementById("addStickerBtn").disabled = false;
  }
  function updateSticker() {
    if (editIndex < 0) return;
    const name = document.getElementById("stickerName").value.trim();
    const label = document.getElementById("stickerLabel").value;
    const stock = parseInt(document.getElementById("initialStock").value);
    const cost = parseFloat(document.getElementById("stickerCost").value) || 0;
    if (!name || !label || isNaN(stock) || stock < 0) {
      alert("Please enter valid sticker name, label and stock."); return;
    }
    if (inventory.some((s, idx) => idx !== editIndex && s.name && s.name.toLowerCase() === name.toLowerCase())) {
      alert('Sticker with this name already exists.'); return;
    }
    let s = inventory[editIndex];
    s.name = name; s.label = label; s.totalStock = stock;
    let used = s.totalStock - s.remainingStock;
    s.remainingStock = Math.max(0, stock - used);
    s.costPerSticker = cost;
    saveInventory().then(() => {
      editIndex = -1;
      updateSelectors();
      updateReport();
      document.getElementById("addStickerBtn").textContent = "‚ûï Add Sticker";
      document.getElementById("addStickerBtn").onclick = addSticker;
      clearStickerForm();
    });
  }
  function deleteSticker(i) {
    if (!confirm("‚ö†Ô∏è Delete sticker and ALL usage records?")) return;
    inventory.splice(i, 1);
    saveInventory().then(() => {
      updateSelectors();
      updateReport();
    });
  }
  function deductStock() {
    const deductBtn = document.getElementById("deductBtn");
    if (!deductBtn || deductBtn.disabled) return;
    deductBtn.disabled = true;
    if (inventory.length === 0) {
      alert("No stickers in inventory.");
      deductBtn.disabled = false;
      return;
    }
    const index = parseInt(document.getElementById("selectSticker").value);
    const department = document.getElementById("department").value;
    const person = document.getElementById("person").value.trim();
    const date = document.getElementById("deductDate").value;
    const amount = parseInt(document.getElementById("deductAmount").value);
    if (isNaN(index) || index < 0 || index >= inventory.length || !department || !person || !date || isNaN(amount) || amount <= 0) {
      alert("Please fill in all fields correctly.");
      deductBtn.disabled = false;
      return;
    }
    const item = inventory[index];
    if (amount > item.remainingStock) {
      alert(`Not enough stock. Only ${item.remainingStock} left.`);
      deductBtn.disabled = false;
      return;
    }
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    item.remainingStock -= amount;
    item.usage.push({ department, amount, person, date, time: timeString });
    saveInventory().then(() => {
      updateReport();
      document.getElementById("selectSticker").value = "";
      document.getElementById("department").value = "";
      document.getElementById("person").value = "";
      document.getElementById("deductDate").value = new Date().toISOString().split('T')[0];
      document.getElementById("deductAmount").value = "";
    }).catch(error => {
        console.error("Error saving deduction:", error);
        alert("An error occurred. The deduction might not have been saved.");
    }).finally(() => {
        if (deductBtn) {
            deductBtn.disabled = false;
            validateDeduct();
        }
    });
  }
  function updateSelectors() {
    const select = document.getElementById("selectSticker");
    select.innerHTML = "";
    let placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "--Select Sticker--";
    select.appendChild(placeholder);
    inventory.forEach((item, index) => {
      const option = document.createElement("option");
      option.value = index;
      option.textContent = item.label || item.name || 'Sticker';
      select.appendChild(option);
    });
    applyRolePermissions();
  }
  function updateReport() {
    const reportTableBody = document.querySelector("#reportTable tbody");
    reportTableBody.innerHTML = "";
    if (inventory.length === 0) {
      reportTableBody.innerHTML = `<tr><td colspan="9" class="text-center" style="padding: 40px; font-size: 1.2rem;">No sticker data available. Please add a new sticker.</td></tr>`;
      return;
    }
    inventory.forEach((item, index) => {
      const row = reportTableBody.insertRow();
      let totalUsed = 0;
      let lastUsedDate = "N/A";
      let lastUsedPerson = "N/A";
      let lastUsedTime = "N/A";
      if (item.usage && item.usage.length > 0) {
        totalUsed = item.usage.reduce((sum, u) => sum + u.amount, 0);
        const sortedUsage = [...item.usage].sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          if (dateA.getTime() !== dateB.getTime()) return dateB.getTime() - dateA.getTime();
          if (a.time && b.time) return b.time.localeCompare(a.time);
          return b.amount - a.amount;
        });
        const lastUsage = sortedUsage[0];
        lastUsedDate = lastUsage.date;
        lastUsedPerson = lastUsage.person;
        lastUsedTime = lastUsage.time || "N/A";
      }
      let rowClass = "";
      if (item.remainingStock === 0) rowClass = "out-stock";
      else if (item.remainingStock <= 5) rowClass = "low-stock";
      if (rowClass) row.classList.add(rowClass);
      row.innerHTML = `
        <td style="font-weight: 500;">${item.label || item.name || 'N/A'}</td>
        <td>${totalUsed}</td>
        <td style="font-weight: 600;">${item.remainingStock}</td>
        <td>${item.totalStock}</td>
        <td class="admin-price">R${item.costPerSticker ? item.costPerSticker.toFixed(2) : '0.00'}</td>
        <td class="admin-price">R${(item.totalStock * (item.costPerSticker || 0)).toFixed(2)}</td>
        <td>${lastUsedDate}<br><small style="opacity: 0.8;">${lastUsedTime}</small></td>
        <td>${lastUsedPerson}</td>
        <td class="admin-only">
          <button class="action-btn eye-btn" onclick="showUsageModal(${index})" title="View Usage Log"><i class="fas fa-eye"></i></button>
          <button class="action-btn" onclick="showAddStockModal(${index})" title="Add Stock"><i class="fas fa-plus"></i></button>
          <button class="action-btn edit-btn" onclick="editSticker(${index})" title="Edit Sticker"><i class="fas fa-edit"></i></button>
          <button class="action-btn del-btn" onclick="deleteSticker(${index})" title="Delete Sticker"><i class="fas fa-trash"></i></button>
        </td>
      `;
    });
    applyRolePermissions();
  }
  function showAddStockModal(i) {
    addStockIndex = i;
    document.getElementById('addStockStickerName').textContent = inventory[i].label || inventory[i].name;
    document.getElementById('addStockAmount').value = "";
    document.getElementById('addStockModal').style.display = 'flex';
    setTimeout(()=>{document.getElementById('addStockAmount').focus()},250);
  }
  function hideAddStockModal() {
    document.getElementById('addStockModal').style.display = 'none';
    addStockIndex = -1;
  }
  function addStockToSticker() {
    const amt = parseInt(document.getElementById('addStockAmount').value);
    if (isNaN(amt) || amt <= 0) { alert("Enter a valid amount."); return; }
    inventory[addStockIndex].totalStock += amt;
    inventory[addStockIndex].remainingStock += amt;
    saveInventory().then(() => {
        updateReport();
        hideAddStockModal();
    });
  }
  function showUsageModal(idx) {
    usageModalIndex = idx;
    const sticker = inventory[idx];
    let html = "";
    if (sticker.usage && sticker.usage.length) {
      html += `<table id="usageListTable"><thead><tr>
        <th>Date</th><th>Time</th><th>Person</th><th>Dept</th><th>Amt</th>
        <th class="admin-only">Actions</th>
      </tr></thead><tbody>`;
      sticker.usage.slice().reverse().forEach(u => {
        html += `<tr>
          <td>${u.date}</td>
          <td>${u.time || 'N/A'}</td>
          <td>${u.person}</td>
          <td>${u.department.charAt(0).toUpperCase() + u.department.slice(1)}</td>
          <td>${u.amount}</td>
          <td class="admin-only">
            <button class="action-btn del-btn" onclick="deleteUsage(${idx}, '${u.date}', '${u.time || ''}', '${u.person}', '${u.department}', ${u.amount})" title="Delete Usage"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
      });
      html += "</tbody></table>";
    } else {
      html = `<p class="text-center" style="font-size: 1.1rem; padding: 20px;">No usage log found for this sticker.</p>`;
    }
    document.getElementById('usageListContent').innerHTML = html;
    document.getElementById('usageModal').style.display = 'flex';
  }
  function hideUsageModal() {
    document.getElementById('usageModal').style.display = 'none';
    usageModalIndex = -1;
  }
  function deleteUsage(stickerIndex, date, time, person, department, amount) {
    if (!confirm("Delete this usage record?")) return;
    if (userRole !== "admin") {
      alert("Only admins can delete usage records.");
      return;
    }
    const sticker = inventory[stickerIndex];
    const usageIndex = sticker.usage.findIndex(u =>
      u.date === date &&
      u.time === time &&
      u.person === person &&
      u.department === department &&
      u.amount === amount
    );
    if (usageIndex !== -1) {
      sticker.usage.splice(usageIndex, 1);
      sticker.remainingStock += amount;
      saveInventory().then(() => {
        updateReport();
        showUsageModal(stickerIndex);
      });
    }
  }
  function showStatsModal() {
    document.getElementById('statsModal').style.display = 'flex';
    showStatsTab('daily');
  }
  function hideStatsModal() {
    document.getElementById('statsModal').style.display = 'none';
  }
  function showStatsTab(tab) {
    ['daily', 'weekly', 'monthly', 'last-month', 'last-week'].forEach(x => document.getElementById('tab-' + x).classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    let now = new Date();
    let startDate, endDate;
    if (tab === "daily") {
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
    } else if (tab === "weekly") {
      const day = now.getDay() || 7;
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
    } else if (tab === "monthly") {
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    } else if (tab === "last-month") {
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), 1);
    } else if (tab === "last-week") {
      const day = now.getDay() || 7;
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1 - 7);
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1);
    }
    let departmentStats = {};
    let detailedDepartmentStats = {};
    let labelUsedStats = {};
    let totalUsed = 0;
    let totalCost = 0;
    inventory.forEach(item => {
      item.usage.forEach(u => {
        let d = new Date(u.date);
        if (d >= startDate && d < endDate) {
          if (!departmentStats[u.department]) departmentStats[u.department] = { used: 0, cost: 0 };
          if (!detailedDepartmentStats[u.department]) detailedDepartmentStats[u.department] = {};
          const label = item.label || item.name;
          if (!detailedDepartmentStats[u.department][label]) detailedDepartmentStats[u.department][label] = 0;
          detailedDepartmentStats[u.department][label] += u.amount;
          departmentStats[u.department].used += u.amount;
          departmentStats[u.department].cost += u.amount * (item.costPerSticker || 0);
          totalUsed += u.amount;
          totalCost += u.amount * (item.costPerSticker || 0);
          if (!labelUsedStats[label]) labelUsedStats[label] = 0;
          labelUsedStats[label] += u.amount;
        }
      });
    });
    let html = `<h4 style="margin-bottom:20px; font-size: 1.4rem;"><i class="fas fa-chart-bar"></i> Department Usage Summary</h4><table id="statsTable"><thead>
        <tr><th>Department</th><th>Used</th>${userRole === "admin" ? '<th>Total Cost</th>' : ''}</tr>
        </thead><tbody>`;
    const sortedDepartments = Object.keys(departmentStats).sort();
    if (sortedDepartments.length === 0) {
      html += `<tr><td colspan="${userRole === "admin" ? "3" : "2"}" class="text-center" style="padding: 25px;">No usage found for this period.</td></tr>`;
    } else {
      sortedDepartments.forEach(dept => {
        const stats = departmentStats[dept];
        html += `<tr>
          <td style="font-weight: 500;">${dept.charAt(0).toUpperCase() + dept.slice(1)}</td>
          <td style="font-weight: 600;">${stats.used}</td>
          ${userRole === "admin" ? `<td style="font-weight: 600;">R${stats.cost.toFixed(2)}</td>` : ""}
        </tr>`;
      });
      html += `<tr style="font-weight:700; background-color: rgba(67, 56, 202, 0.05);">
        <td class="total-col">Total</td>
        <td class="total-col">${totalUsed}</td>
        ${userRole === "admin" ? `<td class="total-col">R${totalCost.toFixed(2)}</td>` : ""}
      </tr>`;
    }
    html += "</tbody></table>";
    if (Object.keys(detailedDepartmentStats).length > 0) {
      html += `<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);"><h4 style="margin-bottom:15px; font-size: 1.3rem;"><i class="fas fa-list"></i> Labels Used by Department</h4>`;
      sortedDepartments.forEach(dept => {
        const labels = detailedDepartmentStats[dept];
        if (Object.keys(labels).length > 0) {
          html += `<h5 style="margin: 15px 0 10px; font-size: 1.1rem; color: var(--accent-primary);">${dept.charAt(0).toUpperCase() + dept.slice(1)}</h5><ul style="list-style-type: none; padding-left: 20px;">`;
          Object.keys(labels).sort().forEach(label => {
            html += `<li style="margin-bottom: 6px; padding: 5px; border-radius: var(--radius-xs); background-color: rgba(0,0,0,0.02);">${label}: <strong>${labels[label]}</strong></li>`;
          });
          html += `</ul>`;
        }
      });
      html += `</div>`;
    }
    const sortedLabels = Object.keys(labelUsedStats).sort();
    if (sortedLabels.length > 0) {
      html += `<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);"><h4 style="margin-bottom:15px; font-size: 1.3rem;"><i class="fas fa-tags"></i> Total Labels Used</h4><ul style="list-style-type: none; padding-left: 20px;">`;
      sortedLabels.forEach(label => {
        html += `<li style="margin-bottom: 6px; padding: 5px; border-radius: var(--radius-xs); background-color: rgba(0,0,0,0.02);">${label}: <strong>${labelUsedStats[label]}</strong></li>`;
      });
      html += `</ul></div>`;
    }
    document.getElementById('statsContent').innerHTML = html;
  }
  // --- EXPORT FUNCTIONS (UNCHANGED) ---
  function getFilteredUsageData(startDate, endDate) {
    const filteredData = [];
    inventory.forEach(item => {
      item.usage.forEach(u => {
        let usageDate = new Date(u.date);
        usageDate.setHours(0, 0, 0, 0);
        if (usageDate >= startDate && usageDate < endDate) {
          filteredData.push({
            stickerName: item.label || item.name || '',
            department: u.department,
            person: u.person,
            date: u.date,
            amount: u.amount,
            costPerSticker: item.costPerSticker || 0,
            time: u.time
          });
        }
      });
    });
    return filteredData;
  }
  function exportToCSV(startDate, endDate) {
    const dataToExport = getFilteredUsageData(startDate, endDate);
    if (dataToExport.length === 0) {
      alert("No data found for the selected period.");
      return;
    }
    let totalAmount = 0;
    let totalOverallCost = 0;
    let csv = "Sticker Label,Date,Time,Department,Person,Amount,Cost Each,Total Cost\r\n";
    dataToExport.forEach(row => {
      const totalCost = row.amount * row.costPerSticker;
      csv += `"${row.stickerName}",${row.date},${row.time || ''},"${row.department.charAt(0).toUpperCase() + row.department.slice(1)}","${row.person}",${row.amount},R${row.costPerSticker.toFixed(2)},R${totalCost.toFixed(2)}\r\n`;
      totalAmount += row.amount;
      totalOverallCost += totalCost;
    });
    csv += `\r\nTotal,,,,,,${totalAmount},R${totalOverallCost.toFixed(2)}\r\n`;
    const blob = new Blob([csv], {type: 'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `sticker_usage_report_${startDate.toISOString().split('T')[0]}_to_${endDate.toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
  }
  function exportToPDF(startDate, endDate) {
    const dataToExport = getFilteredUsageData(startDate, endDate);
    if (dataToExport.length === 0) {
      alert("No data found for the selected period.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text(`Sticker Usage Report`, 14, 15);
    doc.setFontSize(12);
    doc.text(`Period: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`, 14, 25);
    let totalAmount = 0;
    let totalOverallCost = 0;
    const rows = dataToExport.map(row => {
      const totalCost = row.amount * row.costPerSticker;
      totalAmount += row.amount;
      totalOverallCost += totalCost;
      return [
        row.stickerName,
        row.date,
        row.time || '',
        row.department.charAt(0).toUpperCase() + row.department.slice(1),
        row.person,
        row.amount.toString(),
        "R" + row.costPerSticker.toFixed(2),
        "R" + totalCost.toFixed(2)
      ];
    });
    rows.push(
      ["", "", "", "", "Total", totalAmount.toString(), "", `R${totalOverallCost.toFixed(2)}`]
    );
    doc.autoTable({
      head: [["Sticker Label", "Date", "Time", "Department", "Person", "Amount", "Cost Each", "Total Cost"]],
      body: rows,
      startY: 35,
      styles: { fontSize: 9, cellPadding: 3 },
      headStyles: { fillColor: [67, 56, 202], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [248, 250, 252] },
      didParseCell: function(data) {
        if (data.row.index === rows.length - 1) {
          data.cell.styles.fontStyle = 'bold';
          data.cell.styles.fillColor = [224, 231, 255];
        }
      }
    });
    doc.save(`sticker_usage_report_${startDate.toISOString().split('T')[0]}_to_${endDate.toISOString().split('T')[0]}.pdf`);
  }
  function exportLabelsUsageCSV(startDate, endDate) {
    const labelUsage = {};
    inventory.forEach(item => {
        const label = item.label || item.name;
        item.usage.forEach(u => {
            let usageDate = new Date(u.date);
            usageDate.setHours(0, 0, 0, 0);
            if (usageDate >= startDate && usageDate < endDate) {
                if (!labelUsage[label]) labelUsage[label] = 0;
                labelUsage[label] += u.amount;
            }
        });
    });
    if (Object.keys(labelUsage).length === 0) {
        alert("No label usage data found for the selected period.");
        return;
    }
    let csv = "Sticker Label,Total Amount Used\r\n";
    let grandTotalUsed = 0;
    Object.keys(labelUsage).sort().forEach(label => {
        csv += `"${label}",${labelUsage[label]}\r\n`;
        grandTotalUsed += labelUsage[label];
    });
    csv += `\r\nTotal,,${grandTotalUsed}\r\n`;
    const blob = new Blob([csv], {type: 'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `sticker_labels_usage_report_${startDate.toISOString().split('T')[0]}_to_${endDate.toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
  }
  function downloadJSON() {
    const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventory, null, 2));
    const dlAnchor = document.createElement('a');
    dlAnchor.setAttribute("href", dataStr);
    dlAnchor.setAttribute("download", "sticker_inventory_backup.json");
    document.body.appendChild(dlAnchor);
    dlAnchor.click();
    document.body.removeChild(dlAnchor);
  }
  function uploadJSON(evt) {
    let file = evt.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
      try {
        let data = JSON.parse(e.target.result);
        if (Array.isArray(data)) {
          if (confirm("‚ö†Ô∏è This will REPLACE ALL current data. Continue?")) {
            inventory = data;
            saveInventory().then(() => {
              updateSelectors();
              updateReport();
              alert("Upload successful!");
            });
          }
        } else { alert("Invalid file format. Please upload a JSON file."); }
      } catch(err) { alert("Invalid file format. Please upload a valid JSON file."); }
    };
    reader.readAsText(file);
    evt.target.value = "";
  }
  function resetAllData() {
    if (!confirm("‚ö†Ô∏è DELETE ALL data permanently? This cannot be undone.")) return;
    inventory = [];
    saveInventory().then(() => {
      updateSelectors();
      updateReport();
    });
  }
  // --- FORM VALIDATION ---
  function validateAddSticker() {
    const name = document.getElementById("stickerName").value.trim();
    const label = document.getElementById("stickerLabel").value;
    const stock = parseInt(document.getElementById("initialStock").value);
    const cost = parseFloat(document.getElementById("stickerCost").value);
    document.getElementById("addStickerBtn").disabled = !(name && label && !isNaN(stock) && stock >= 0 && !isNaN(cost) && cost >= 0);
  }
  function validateDeduct() {
    const stickerIdx = document.getElementById("selectSticker").value;
    const dep = document.getElementById("department").value;
    const per = document.getElementById("person").value.trim();
    const date = document.getElementById("deductDate").value;
    const amt = parseInt(document.getElementById("deductAmount").value);
    document.getElementById("deductBtn").disabled = !(stickerIdx !== "" && dep && per && date && !isNaN(amt) && amt > 0 && inventory.length > 0);
  }
  ["stickerName", "stickerLabel", "initialStock", "stickerCost"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener("input", validateAddSticker);
        el.addEventListener("change", validateAddSticker);
    }
  });
  ["selectSticker", "department", "person", "deductDate", "deductAmount"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener("input", validateDeduct);
        el.addEventListener("change", validateDeduct);
    }
  });
  // --- MODAL CONTROLLERS ---
  function showExportDateSelectionModal(type) {
    exportType = type;
    document.getElementById('exportDateSelectionModal').style.display = 'flex';
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    document.getElementById('exportMonth').value = `${year}-${month}`;
    const todayStr = today.toISOString().split('T')[0];
    document.getElementById('exportWeekStart').value = todayStr;
    document.getElementById('exportWeekEnd').value = todayStr;
    document.getElementById('exportRangeStart').value = todayStr;
    document.getElementById('exportRangeEnd').value = todayStr;
    showExportOption('month');
  }
  function hideExportDateSelectionModal() {
    document.getElementById('exportDateSelectionModal').style.display = 'none';
    exportType = '';
    exportOption = 'month';
  }
  function showExportOption(option) {
    exportOption = option;
    document.getElementById('exportMonthOption').style.display = 'none';
    document.getElementById('exportWeekOption').style.display = 'none';
    document.getElementById('exportRangeOption').style.display = 'none';
    document.querySelectorAll('#exportDateSelectionTabs button').forEach(btn => btn.classList.remove('active'));
    if (option === 'month') {
      document.getElementById('exportMonthOption').style.display = 'block';
      document.getElementById('export-tab-month').classList.add('active');
    } else if (option === 'week') {
      document.getElementById('exportWeekOption').style.display = 'block';
      document.getElementById('export-tab-week').classList.add('active');
    } else if (option === 'range') {
      document.getElementById('exportRangeOption').style.display = 'block';
      document.getElementById('export-tab-range').classList.add('active');
    } else if (option === 'all') {
      document.getElementById('export-tab-all').classList.add('active');
    }
  }
  document.getElementById('confirmExportBtn').addEventListener('click', () => {
    let startDate, endDate;
    if (exportOption === 'month') {
      const monthInput = document.getElementById('exportMonth').value;
      if (!monthInput) { alert("Please select a month."); return; }
      const [year, month] = monthInput.split('-').map(Number);
      startDate = new Date(year, month - 1, 1);
      endDate = new Date(year, month, 1);
    } else if (exportOption === 'week') {
      const weekStartStr = document.getElementById('exportWeekStart').value;
      const weekEndStr = document.getElementById('exportWeekEnd').value;
      if (!weekStartStr || !weekEndStr) { alert("Please select both start and end dates."); return; }
      startDate = new Date(weekStartStr);
      endDate = new Date(weekEndStr);
      endDate.setDate(endDate.getDate() + 1);
    } else if (exportOption === 'range') {
      const rangeStartStr = document.getElementById('exportRangeStart').value;
      const rangeEndStr = document.getElementById('exportRangeEnd').value;
      if (!rangeStartStr || !rangeEndStr) { alert("Please select both start and end dates."); return; }
      startDate = new Date(rangeStartStr);
      endDate = new Date(rangeEndStr);
      endDate.setDate(endDate.getDate() + 1);
    } else if (exportOption === 'all') {
      startDate = new Date(0);
      endDate = new Date();
      endDate.setDate(endDate.getDate() + 1);
    }
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(0, 0, 0, 0);
    if (exportType === 'csv') {
      exportToCSV(startDate, endDate);
    } else if (exportType === 'pdf') {
      exportToPDF(startDate, endDate);
    } else if (exportType === 'labels_usage_csv') {
      exportLabelsUsageCSV(startDate, endDate);
    }
    hideExportDateSelectionModal();
  });
  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', function() {
    const deductBtn = document.getElementById("deductBtn");
    if (deductBtn) {
        deductBtn.addEventListener("click", function() {
            if (!this.disabled) deductStock();
        });
    }
  });
  window.onload = async () => {
    showLoader(true);
    await loadInventory();
    updateSelectors();
    updateReport();
    document.getElementById("deductDate").value = new Date().toISOString().split('T')[0];
    showLoader(false);
    validateAddSticker();
    validateDeduct();
    document.getElementById("loginModal").style.display = "flex";
    document.getElementById("loginPassword").focus();
  };
</script>
</body>
</html>